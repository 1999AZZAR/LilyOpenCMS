{% extends 'admin_base.html' %}
{% block title %}Manajemen Akun - Admin{% endblock %}
{% block hero_title %}Manajemen Akun{% endblock %}
{% block hero_desc %}Kelola berita Anda, kata sandi, dan pengaturan akun{% endblock %}
{% block content %}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8" role="main">
    <!-- Password Management Card -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6" role="region" aria-labelledby="password-management-title">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center" role="img" aria-label="Password management icon">
            <i class="fas fa-lock text-xl text-white"></i>
          </div>
          <h2 id="password-management-title" class="text-xl font-bold text-gray-900">Manajemen Kata Sandi</h2>
        </div>
        <button onclick="editPasswordSettings()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Edit Password Settings">
          <i class="fas fa-edit"></i>
        </button>
      </div>
      <form id="change-password-form" class="space-y-4" role="form" aria-label="Change password form">
        <div>
          <label for="current-password" class="block text-gray-700 font-medium mb-2">Kata Sandi Saat Ini</label>
          <input type="password" id="current-password" class="w-full p-3 rounded-lg bg-white border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" required aria-required="true">
        </div>
        <div>
          <label for="new-password" class="block text-gray-700 font-medium mb-2">Kata Sandi Baru</label>
          <input type="password" id="new-password" class="w-full p-3 rounded-lg bg-white border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" required aria-required="true">
        </div>
        <div>
          <label for="confirm-password" class="block text-gray-700 font-medium mb-2">Konfirmasi Kata Sandi Baru</label>
          <input type="password" id="confirm-password" class="w-full p-3 rounded-lg bg-white border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" required aria-required="true">
        </div>
        <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 rounded-lg font-semibold transition-all duration-300 shadow-md" aria-label="Ubah kata sandi">
          Ubah Kata Sandi
        </button>
      </form>
      <div id="password-status" class="mt-4" role="status" aria-live="polite"></div>
    </div>

    <!-- Delete Account Card -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6" role="region" aria-labelledby="delete-account-title">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-full flex items-center justify-center" role="img" aria-label="Delete account icon">
            <i class="fas fa-user-slash text-xl text-white"></i>
          </div>
          <h2 id="delete-account-title" class="text-xl font-bold text-red-600">Hapus Akun</h2>
        </div>
        <button onclick="editAccountSettings()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Edit Account Settings">
          <i class="fas fa-edit"></i>
        </button>
      </div>
      <p class="text-gray-600 mb-4 text-sm">Peringatan: Tindakan ini tidak dapat dibatalkan. Semua data Anda, termasuk artikel berita, akan dihapus secara permanen.</p>
      <button onclick="openDeleteAccountModal()" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 rounded-lg font-semibold transition-all duration-300 shadow-md" aria-label="Hapus akun" aria-haspopup="dialog">
        Hapus Akun
      </button>
    </div>

    <!-- Profile Information Card -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6" role="region" aria-labelledby="profile-info-title">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-full flex items-center justify-center" role="img" aria-label="Profile info icon">
            <i class="fas fa-user text-xl text-white"></i>
          </div>
          <h2 id="profile-info-title" class="text-xl font-bold text-gray-900">Informasi Profil</h2>
        </div>
        <button onclick="editProfileSettings()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Edit Profile Settings">
          <i class="fas fa-edit"></i>
        </button>
      </div>
      <div class="space-y-3">
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Nama Lengkap</span>
          <span id="profile-full-name" class="text-gray-900 font-bold">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Username</span>
          <span id="profile-username" class="text-gray-900 font-bold">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Email</span>
          <span id="profile-email" class="text-gray-900 font-bold">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Tanggal Lahir</span>
          <span id="profile-birthdate" class="text-gray-900 font-bold">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Usia</span>
          <span id="profile-age" class="text-gray-900 font-bold">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Role</span>
          <span id="profile-role" class="text-gray-900 font-bold">-</span>
        </div>
      </div>
    </div>

    <!-- Account Stats Card -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6" role="region" aria-labelledby="account-stats-title">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center" role="img" aria-label="Account stats icon">
            <i class="fas fa-chart-bar text-xl text-white"></i>
          </div>
          <h2 id="account-stats-title" class="text-xl font-bold text-gray-900">Statistik Akun</h2>
        </div>
        <button onclick="refreshStats()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Refresh Stats">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <div class="space-y-3">
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Total Artikel</span>
          <span id="total-articles" class="text-gray-900 font-bold">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Artikel Terlihat</span>
          <span id="visible-articles" class="text-green-600 font-bold">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Total Dibaca</span>
          <span id="total-reads" class="text-blue-600 font-bold">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Total Buku/Seri</span>
          <span id="total-albums" class="text-purple-600 font-bold">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Total Bab</span>
          <span id="total-chapters" class="text-indigo-600 font-bold">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-700 font-medium">Total Komentar</span>
          <span id="total-comments" class="text-orange-600 font-bold">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters for Owned News -->
  <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6 mb-8" role="region" aria-labelledby="news-filters-title">
    <h2 id="news-filters-title" class="text-xl font-semibold mb-4 text-gray-900">Filter Artikel Anda</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4" role="search">
      <div class="lg:col-span-2">
        <label for="owned-search" class="block text-sm font-medium text-gray-700 mb-1">Cari Artikel</label>
        <input type="text" id="owned-search" placeholder="Cari berdasarkan judul..." class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Cari artikel Anda berdasarkan judul">
      </div>
      
      <div>
        <label for="owned-status-filter" class="block text-sm font-medium text-gray-700 mb-1">Keterlihatan</label>
        <select id="owned-status-filter" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Filter Keterlihatan">
          <option value="">Semua</option>
          <option value="visible">Terlihat</option>
          <option value="hidden">Tersembunyi</option>
        </select>
      </div>
      
      <div>
        <label for="owned-premium-filter" class="block text-sm font-medium text-gray-700 mb-1">Tipe Artikel</label>
        <select id="owned-premium-filter" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Filter Artikel atau Berita">
          <option value="">Semua</option>
          <option value="true">Artikel</option>
          <option value="false">Berita</option>
        </select>
      </div>
      
      <div>
        <label for="owned-filter-featured-image" class="block text-sm font-medium text-gray-700 mb-1">Gambar Unggulan</label>
        <select id="owned-filter-featured-image" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Filter Gambar Unggulan">
          <option value="">Semua</option>
          <option value="has_image">Dengan Gambar</option>
          <option value="no_image">Tanpa Gambar</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Your News and Articles List -->
  <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6" role="region" aria-labelledby="news-list-title">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center" role="img" aria-label="News and articles icon">
          <i class="fas fa-newspaper text-white"></i>
        </div>
        <h2 id="news-list-title" class="text-2xl font-bold text-gray-900">Berita dan Artikel Anda</h2>
      </div>
      <div class="text-sm text-gray-600">
        <span id="articles-count">0</span> artikel ditemukan
      </div>
    </div>
    
    <div id="owned-news-list" class="grid grid-cols-1 lg:grid-cols-2 gap-6" role="list" aria-label="List of your news and articles">
      <p class="text-gray-400 col-span-full text-center" role="status">Memuat artikel Anda...</p>
    </div>
    
    <!-- Pagination Controls for Owned News -->
    <div id="owned-pagination-controls" class="mt-6" role="navigation" aria-label="Pagination controls">
      <!-- Pagination will be dynamically generated here -->
    </div>
  </div>

  <!-- Your Albums/Books List -->
  <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6 mt-8" role="region" aria-labelledby="albums-list-title">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center" role="img" aria-label="Albums icon">
          <i class="fas fa-book-open text-white"></i>
        </div>
        <h2 id="albums-list-title" class="text-2xl font-bold text-gray-900">Buku/Seri Anda</h2>
      </div>
      <div class="flex items-center space-x-3">
        <div class="text-sm text-gray-600">
          <span id="albums-count">0</span> buku/seri ditemukan
        </div>
        <a href="{{ url_for('albums.create_album') }}" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
          <i class="fas fa-plus mr-2"></i>Buat Buku/Seri
        </a>
      </div>
    </div>
    
    <!-- Albums Filters -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div>
        <label for="albums-search" class="block text-sm font-medium text-gray-700 mb-1">Cari Buku/Seri</label>
        <input type="text" id="albums-search" placeholder="Cari berdasarkan judul..." class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" aria-label="Cari buku/seri Anda berdasarkan judul">
      </div>
      
      <div>
        <label for="albums-status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
        <select id="albums-status-filter" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" aria-label="Filter Status">
          <option value="">Semua Status</option>
          <option value="visible">Terlihat</option>
          <option value="hidden">Tersembunyi</option>
          <option value="archived">Arsip</option>
        </select>
      </div>
      
      <div>
        <label for="albums-type-filter" class="block text-sm font-medium text-gray-700 mb-1">Tipe</label>
        <select id="albums-type-filter" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" aria-label="Filter Tipe">
          <option value="">Semua Tipe</option>
          <option value="regular">Regular</option>
          <option value="premium">Premium</option>
        </select>
      </div>
    </div>
    
    <div id="owned-albums-list" class="grid grid-cols-1 lg:grid-cols-2 gap-6" role="list" aria-label="List of your albums and books">
      <p class="text-gray-400 col-span-full text-center" role="status">Memuat buku/seri Anda...</p>
    </div>
    
    <!-- Pagination Controls for Albums -->
    <div id="albums-pagination-controls" class="mt-6" role="navigation" aria-label="Albums pagination controls">
      <!-- Pagination will be dynamically generated here -->
    </div>
  </div>

  <!-- Recent Activity & Comments -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
    <!-- Recent Comments -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6" role="region" aria-labelledby="recent-comments-title">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-orange-600 rounded-full flex items-center justify-center" role="img" aria-label="Comments icon">
            <i class="fas fa-comments text-white"></i>
          </div>
          <h2 id="recent-comments-title" class="text-xl font-bold text-gray-900">Komentar Terbaru</h2>
        </div>
        <button onclick="refreshComments()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Refresh Comments">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <div id="recent-comments-list" class="space-y-3">
        <p class="text-gray-400 text-center" role="status">Memuat komentar...</p>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-6" role="region" aria-labelledby="recent-activity-title">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center" role="img" aria-label="Activity icon">
            <i class="fas fa-clock text-white"></i>
          </div>
          <h2 id="recent-activity-title" class="text-xl font-bold text-gray-900">Aktivitas Terbaru</h2>
        </div>
        <button onclick="refreshActivity()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Refresh Activity">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      <div id="recent-activity-list" class="space-y-3">
        <p class="text-gray-400 text-center" role="status">Memuat aktivitas...</p>
      </div>
    </div>
  </div>

  <!-- Delete Account Modal -->
  <div id="delete-account-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center p-4 z-50" role="dialog" aria-labelledby="delete-account-modal-title" aria-modal="true">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
      <div class="flex items-center space-x-3 mb-4">
        <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center">
          <i class="fas fa-exclamation-triangle text-white"></i>
        </div>
        <h2 id="delete-account-modal-title" class="text-xl font-bold text-red-600">Hapus Akun</h2>
      </div>
      <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus akun Anda? Tindakan ini tidak dapat dibatalkan dan semua data Anda akan hilang selamanya.</p>
      <div class="flex space-x-3">
        <button onclick="closeDeleteAccountModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-colors duration-300" aria-label="Batal hapus akun">Batal</button>
        <button id="confirm-delete-account-btn" class="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition-colors duration-300" aria-label="Konfirmasi hapus akun">Hapus Akun</button>
      </div>
    </div>
  </div>

  <!-- Profile Edit Modal -->
  <div id="profile-edit-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center p-4 z-50" role="dialog" aria-labelledby="profile-edit-modal-title" aria-modal="true">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
      <div class="flex items-center space-x-3 mb-4">
        <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center">
          <i class="fas fa-user-edit text-white"></i>
        </div>
        <h2 id="profile-edit-modal-title" class="text-xl font-bold text-indigo-600">Edit Profil</h2>
      </div>
      <form id="profile-edit-form" class="space-y-4">
        <div>
          <label for="edit-full-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
          <input type="text" id="edit-full-name" class="w-full p-3 rounded-lg bg-white border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
        </div>
        <div>
          <label for="edit-birthdate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lahir</label>
          <input type="date" id="edit-birthdate" class="w-full p-3 rounded-lg bg-white border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <p class="text-xs text-gray-500 mt-1">Kosongkan untuk menghapus tanggal lahir</p>
        </div>
      </form>
      <div class="flex space-x-3 mt-6">
        <button onclick="closeProfileEditModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-colors duration-300" aria-label="Batal edit profil">Batal</button>
        <button id="confirm-profile-edit-btn" class="flex-1 bg-indigo-500 text-white py-3 rounded-lg font-semibold hover:bg-indigo-600 transition-colors duration-300" aria-label="Simpan perubahan profil">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Delete Article Modal -->
  <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center p-4 z-50" role="dialog" aria-labelledby="delete-modal-title" aria-modal="true">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
      <div class="flex items-center space-x-3 mb-4">
        <div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center">
          <i class="fas fa-trash text-white"></i>
        </div>
        <h2 id="delete-modal-title" class="text-xl font-bold text-yellow-600">Hapus Artikel</h2>
      </div>
      <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus artikel ini? Tindakan ini tidak dapat dibatalkan.</p>
      <div class="flex space-x-3">
        <button onclick="closeDeleteModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-colors duration-300" aria-label="Batal hapus artikel">Batal</button>
        <button id="confirm-delete-btn" class="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition-colors duration-300" aria-label="Konfirmasi hapus artikel">Hapus</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/toast.js') }}"></script>
<script src="{{ url_for('static', filename='js/account-crud.js') }}"></script>
<script>
// Enhanced Account Management Functions

// Load profile data
function loadProfileData() {
    fetch('/api/account/profile')
        .then(response => response.json())
        .then(data => {
            document.getElementById('profile-full-name').textContent = data.full_name || 'Tidak diisi';
            document.getElementById('profile-username').textContent = data.username || '-';
            document.getElementById('profile-email').textContent = data.email || '-';
            
            if (data.birthdate) {
                const birthdate = new Date(data.birthdate);
                document.getElementById('profile-birthdate').textContent = birthdate.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } else {
                document.getElementById('profile-birthdate').textContent = 'Tidak diisi';
            }
            
            document.getElementById('profile-age').textContent = data.age ? `${data.age} tahun` : '-';
            
            let roleText = data.role || 'User';
            if (data.custom_role_name) {
                roleText = data.custom_role_name;
            }
            document.getElementById('profile-role').textContent = roleText;
        })
        .catch(error => {
            console.error('Error fetching profile:', error);
            showToast('error', 'Gagal memuat data profil');
        });
}

// Refresh all stats
function refreshStats() {
    fetch('/api/account/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-articles').textContent = data.total_articles || 0;
            document.getElementById('visible-articles').textContent = data.visible_articles || 0;
            document.getElementById('total-reads').textContent = data.total_reads || 0;
            document.getElementById('total-albums').textContent = data.total_albums || 0;
            document.getElementById('total-chapters').textContent = data.total_chapters || 0;
            document.getElementById('total-comments').textContent = data.total_comments || 0;
            showToast('success', 'Statistik diperbarui');
        })
        .catch(error => {
            console.error('Error fetching stats:', error);
            showToast('error', 'Gagal memperbarui statistik');
        });
}

// Edit password settings
function editPasswordSettings() {
    // Focus on the password form
    document.getElementById('current-password').focus();
    showToast('info', 'Silakan isi form kata sandi di bawah');
}

// Edit profile settings
function editProfileSettings() {
    // Load current profile data into the modal
    fetch('/api/account/profile')
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit-full-name').value = data.full_name || '';
            document.getElementById('edit-birthdate').value = data.birthdate || '';
            
            // Show the modal
            document.getElementById('profile-edit-modal').classList.remove('hidden');
            document.getElementById('profile-edit-modal').classList.add('flex');
        })
        .catch(error => {
            console.error('Error loading profile data:', error);
            showToast('error', 'Gagal memuat data profil');
        });
}

// Close profile edit modal
function closeProfileEditModal() {
    document.getElementById('profile-edit-modal').classList.add('hidden');
    document.getElementById('profile-edit-modal').classList.remove('flex');
}

// Edit account settings
function editAccountSettings() {
    // This could open a modal or redirect to account settings page
    showToast('info', 'Fitur pengaturan akun akan segera tersedia');
}

// Load owned albums
function loadOwnedAlbums(page = 1) {
    const search = document.getElementById('albums-search').value;
    const status = document.getElementById('albums-status-filter').value;
    const type = document.getElementById('albums-type-filter').value;
    
    const params = new URLSearchParams({
        page: page,
        search: search,
        status: status,
        type: type
    });
    
    fetch(`/api/account/albums?${params}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('owned-albums-list');
            const countElement = document.getElementById('albums-count');
            
            countElement.textContent = data.total || 0;
            
            if (data.albums && data.albums.length > 0) {
                container.innerHTML = data.albums.map(album => `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-book-open text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${album.title}</h3>
                                    <p class="text-sm text-gray-600">${album.category || 'Uncategorized'}</p>
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <a href="/admin/albums/${album.id}" class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors" title="View">
                                    <i class="fas fa-eye text-lg"></i>
                                </a>
                                <a href="/admin/albums/${album.id}/edit" class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50 transition-colors" title="Edit">
                                    <i class="fas fa-edit text-lg"></i>
                                </a>
                            </div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${album.total_chapters || 0} bab</span>
                            <span>${album.is_visible ? 'Terlihat' : 'Tersembunyi'}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-gray-400 col-span-full text-center">Tidak ada buku/seri ditemukan</p>';
            }
            
            // Update pagination
            updateAlbumsPagination(data);
        })
        .catch(error => {
            console.error('Error loading albums:', error);
            document.getElementById('owned-albums-list').innerHTML = '<p class="text-red-400 col-span-full text-center">Error loading albums</p>';
        });
}

// Update albums pagination
function updateAlbumsPagination(data) {
    const container = document.getElementById('albums-pagination-controls');
    if (!data.pagination) {
        container.innerHTML = '';
        return;
    }
    
    const { page, pages, has_prev, has_next } = data.pagination;
    let paginationHTML = '<div class="flex justify-center space-x-2">';
    
    if (has_prev) {
        paginationHTML += `<button onclick="loadOwnedAlbums(${page - 1})" class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Previous</button>`;
    }
    
    for (let i = 1; i <= pages; i++) {
        if (i === page) {
            paginationHTML += `<span class="px-3 py-2 bg-blue-600 text-white rounded">${i}</span>`;
        } else {
            paginationHTML += `<button onclick="loadOwnedAlbums(${i})" class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">${i}</button>`;
        }
    }
    
    if (has_next) {
        paginationHTML += `<button onclick="loadOwnedAlbums(${page + 1})" class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Next</button>`;
    }
    
    paginationHTML += '</div>';
    container.innerHTML = paginationHTML;
}

// Load recent comments
function refreshComments() {
    fetch('/api/account/comments')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('recent-comments-list');
            
            if (data.comments && data.comments.length > 0) {
                container.innerHTML = data.comments.map(comment => `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-medium text-gray-900">${comment.article_title}</span>
                            <span class="text-xs text-gray-500">${comment.created_at}</span>
                        </div>
                        <p class="text-sm text-gray-700">${comment.content.substring(0, 100)}${comment.content.length > 100 ? '...' : ''}</p>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-gray-400 text-center">Tidak ada komentar</p>';
            }
        })
        .catch(error => {
            console.error('Error loading comments:', error);
            document.getElementById('recent-comments-list').innerHTML = '<p class="text-red-400 text-center">Error loading comments</p>';
        });
}

// Load recent activity
function refreshActivity() {
    fetch('/api/account/activity')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('recent-activity-list');
            
            if (data.activities && data.activities.length > 0) {
                container.innerHTML = data.activities.map(activity => `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-medium text-gray-900">${activity.action}</span>
                            <span class="text-xs text-gray-500">${activity.created_at}</span>
                        </div>
                        <p class="text-sm text-gray-700">${activity.description}</p>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-gray-400 text-center">Tidak ada aktivitas</p>';
            }
        })
        .catch(error => {
            console.error('Error loading activity:', error);
            document.getElementById('recent-activity-list').innerHTML = '<p class="text-red-400 text-center">Error loading activity</p>';
        });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load initial data
    loadProfileData();
    refreshStats();
    loadOwnedAlbums();
    refreshComments();
    refreshActivity();
    
    // Add event listeners for filters
    document.getElementById('albums-search').addEventListener('input', debounce(() => loadOwnedAlbums(), 500));
    document.getElementById('albums-status-filter').addEventListener('change', () => loadOwnedAlbums());
    document.getElementById('albums-type-filter').addEventListener('change', () => loadOwnedAlbums());
    
    // Add profile edit form submission
    document.getElementById('confirm-profile-edit-btn').addEventListener('click', async () => {
        const fullName = document.getElementById('edit-full-name').value.trim();
        const birthdate = document.getElementById('edit-birthdate').value;
        
        if (!fullName) {
            showToast('error', 'Nama lengkap harus diisi');
            return;
        }
        
        try {
            const response = await fetch('/api/account/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    full_name: fullName,
                    birthdate: birthdate || null
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to update profile');
            }
            
            const result = await response.json();
            showToast('success', 'Profil berhasil diperbarui');
            closeProfileEditModal();
            loadProfileData(); // Reload profile data
        } catch (error) {
            console.error('Error updating profile:', error);
            showToast('error', `Gagal memperbarui profil: ${error.message}`);
        }
    });
});

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}
