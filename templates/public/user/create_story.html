{% extends 'base.html' %}

{% block title %}{% if news_id %}Edit Cerita{% else %}Tulis Cerita Baru{% endif %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user-pages.css') }}">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-background">
    <!-- Header -->
    <div class="bg-card border-b border-border">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-foreground">
                        {% if news_id %}Edit Cerita{% else %}Tulis Cerita Baru{% endif %}
                    </h1>
                    <p class="mt-2 text-muted-foreground">
                        {% if news_id %}Perbarui konten cerita Anda{% else %}Bagikan kreativitas Anda dengan komunitas{% endif %}
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('user_profile.user_stories', username=user.username) }}" 
                       class="text-primary hover:text-foreground">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali ke Cerita
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Form Container -->
        <div class="bg-card border border-border p-6 rounded-lg shadow-lg mb-8" role="region" aria-labelledby="create-story-title">
            <h2 id="create-story-title" class="text-xl font-semibold mb-4 text-foreground">Buat Cerita</h2>
            
            <!-- Step Indicator -->
            <div class="flex items-center justify-center mb-6">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div id="step-1-indicator" class="w-8 h-8 bg-primary text-primary-foreground rounded-full flex items-center justify-center font-semibold">1</div>
                        <span class="ml-2 text-sm font-medium text-foreground">Detail</span>
                    </div>
                    <div class="w-12 h-0.5 bg-border"></div>
                    <div class="flex items-center">
                        <div id="step-2-indicator" class="w-8 h-8 bg-muted text-muted-foreground rounded-full flex items-center justify-center font-semibold">2</div>
                        <span class="ml-2 text-sm font-medium text-muted-foreground">Konten</span>
                    </div>
                </div>
            </div>
            
            <form id="create-story-form" class="flex flex-col lg:flex-row gap-6" method="POST" action="{{ url_for('user_profile.create_user_news_api') }}" enctype="multipart/form-data" role="form" aria-label="Form create story" novalidate>
                <!-- Step 1: Details Section (Full Width) -->
                <div id="step-1-content" class="w-full">
                    <div class="h-full flex flex-col">
                        <!-- Title Input -->
                        <div class="mb-6">
                            <input type="text" id="story-title" name="title" 
                                   class="w-full bg-card border-0 border-b-2 border-border text-foreground text-3xl font-light p-4 focus:outline-none focus:border-primary transition-colors" 
                                   placeholder="Judul cerita..." required aria-required="true">
                        </div>
                        
                        <!-- Two Column Layout for Details -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            <!-- Left Column: Story Details -->
                            <div class="lg:col-span-2 space-y-6">
                                
                                <!-- Story Details Card -->
                                <div class="bg-card border border-border rounded-xl shadow-sm overflow-hidden">
                                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-border">
                                        <h3 class="text-lg font-semibold text-foreground flex items-center">
                                            <i class="fas fa-file-alt text-primary mr-3"></i>
                                            Detail Cerita
                                        </h3>
                                        <p class="text-sm text-muted-foreground mt-1">Informasi dasar cerita</p>
                                    </div>
                                    <div class="p-6">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <!-- Category (Required) -->
                                            <div>
                                                <label class="block text-sm font-medium text-foreground mb-2" for="story-category">
                                                    <i class="fas fa-tag text-muted-foreground mr-2"></i>Kategori <span class="text-red-500">*</span>
                                                </label>
                                                <select id="story-category" name="category" 
                                                        class="w-full bg-card border border-border text-foreground text-sm rounded-lg focus:ring-2 focus:ring-primary focus:border-primary p-3 transition-colors" 
                                                        required aria-required="true">
                                                    <option value="" disabled selected>Pilih kategori cerita...</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Date (Required) -->
                                            <div>
                                                <label class="block text-sm font-medium text-foreground mb-2" for="story-date">
                                                    <i class="fas fa-calendar text-muted-foreground mr-2"></i>Tanggal Publikasi <span class="text-red-500">*</span>
                                                </label>
                                                <input type="date" id="story-date" name="date" 
                                                       class="w-full bg-card border border-border text-foreground text-sm rounded-lg focus:ring-2 focus:ring-primary focus:border-primary p-3 transition-colors" 
                                                       required aria-required="true">
                                            </div>
                                            
                                            <!-- Tags -->
                                            <div>
                                                <label class="block text-sm font-medium text-foreground mb-2" for="story-tags">
                                                    <i class="fas fa-hashtag text-muted-foreground mr-2"></i>Tag
                                                </label>
                                                <input type="text" id="story-tags" name="tagar" 
                                                       class="w-full bg-card border border-border text-foreground text-sm rounded-lg focus:ring-2 focus:ring-primary focus:border-primary p-3 transition-colors" 
                                                       placeholder="fantasi, petualangan, misteri" aria-label="Story tags">
                                                <p class="text-xs text-muted-foreground mt-1">Pisahkan tag dengan koma</p>
                                            </div>
                                            
                                            <!-- Age Rating (Required) -->
                                            <div>
                                                <label class="block text-sm font-medium text-foreground mb-2" for="story-age-rating">
                                                    <i class="fas fa-user-shield text-muted-foreground mr-2"></i>Rating Usia <span class="text-red-500">*</span>
                                                </label>
                                                <select id="story-age-rating" name="age_rating" 
                                                        class="w-full bg-card border border-border text-foreground text-sm rounded-lg focus:ring-2 focus:ring-primary focus:border-primary p-3 transition-colors" 
                                                        required aria-required="true">
                                                    <option value="" disabled selected>Pilih rating usia...</option>
                                                    <option value="SU">SU — Semua Umur</option>
                                                    <option value="P">P — Prasekolah (2–6)</option>
                                                    <option value="A">A — Anak-anak (7–12)</option>
                                                    <option value="T">T — Remaja (13+)</option>
                                                    <option value="M">M — Dewasa (18+)</option>
                                                </select>
                                            </div>
                                            
                                            <!-- Writer Name -->
                                            <div>
                                                <label class="block text-sm font-medium text-foreground mb-2" for="story-writer">
                                                    <i class="fas fa-user text-muted-foreground mr-2"></i>Nama Penulis
                                                </label>
                                                <input type="text" id="story-writer" name="writer" 
                                                       class="w-full bg-card border border-border text-foreground text-sm rounded-lg focus:ring-2 focus:ring-primary focus:border-primary p-3 transition-colors" 
                                                       placeholder="Nama penulis" aria-label="Writer name" value="{{ user.username }}">
                                                <p class="text-xs text-muted-foreground mt-1">Nama penulis cerita</p>
                                            </div>

                                            <!-- External Source -->
                                            <div>
                                                <label class="block text-sm font-medium text-foreground mb-2" for="story-external-source">
                                                    <i class="fas fa-link text-muted-foreground mr-2"></i>Sumber Eksternal
                                                </label>
                                                <input type="url" id="story-external-source" name="external_source" 
                                                       class="w-full bg-card border border-border text-foreground text-sm rounded-lg focus:ring-2 focus:ring-primary focus:border-primary p-3 transition-colors" 
                                                       placeholder="https://contoh.com/sumber" aria-label="External source URL">
                                                <p class="text-xs text-muted-foreground mt-1">Opsional - untuk atribusi sumber</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                            
                            <!-- Right Column: Featured Image -->
                            <div class="space-y-6">
                                <!-- Featured Image Card -->
                                <div class="bg-card border border-border rounded-xl shadow-sm overflow-hidden">
                                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 border-b border-border">
                                        <h3 class="text-lg font-semibold text-foreground flex items-center">
                                            <i class="fas fa-image text-green-600 mr-3"></i>
                                            Gambar Utama (Opsional)
                                        </h3>
                                        <p class="text-sm text-muted-foreground mt-1">Pilih gambar untuk cerita Anda (opsional)</p>
                                    </div>
                                    <div class="p-6">
                                        <div id="image-header-section-create" role="group" aria-label="Featured image options">
                                            <input type="hidden" id="story-image-id" name="image_id">
                                            
                                            <!-- Image Preview -->
                                            <div class="mb-4">
                                                <img id="featured-preview-create" src="" 
                                                     class="w-full h-40 object-cover rounded-lg border-2 border-dashed border-border hidden" 
                                                     alt="Featured image preview">
                                                <div id="no-image-placeholder" class="w-full h-40 bg-muted border-2 border-dashed border-border rounded-lg flex items-center justify-center">
                                                    <div class="text-center">
                                                        <i class="fas fa-image text-muted-foreground text-2xl mb-2"></i>
                                                        <p class="text-sm text-muted-foreground">Belum ada gambar utama (opsional)</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="flex space-x-2">
                                                <button type="button" id="open-header-modal-btn" onclick="console.log('Button clicked via onclick'); window.openImageHeaderModalCreate && window.openImageHeaderModalCreate();"
                                                        class="flex-1 bg-primary hover:bg-primary/90 text-primary-foreground py-2 px-3 rounded-lg font-medium text-sm focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-200 flex items-center justify-center" 
                                                        aria-label="Choose featured image">
                                                    <i class="fas fa-plus mr-2"></i>Pilih Gambar (Opsional)
                                                </button>
                                                <button type="button" id="clear-featured-image-btn" 
                                                        class="px-3 py-2 bg-muted hover:bg-muted/80 text-muted-foreground rounded-lg focus:outline-none focus:ring-2 focus:ring-muted transition-all duration-200" 
                                                        aria-label="Remove featured image" title="Remove Featured Image">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 1 Navigation -->
                        <div class="flex justify-end mt-6 pt-4 border-t border-border">
                            <button type="button" id="next-step-btn" 
                                    class="bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-3 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" 
                                    aria-label="Continue to content">
                                Lanjut ke Konten <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Content Section (Hidden by default) -->
                <div id="step-2-content" class="w-full hidden" role="complementary" aria-label="Konten cerita">
                    <div class="h-full flex flex-col">
                                <!-- Content Editor -->
                        <div id="simplemde-wrapper" class="flex flex-col flex-1 overflow-hidden" role="textbox" aria-label="Editor konten cerita">
                            <div id="custom-toolbar" class="flex flex-wrap gap-3 bg-card border border-border p-2 rounded-t-lg mb-2" role="toolbar" aria-label="Toolbar editor">
                                <button type="button" data-cmd="bold" class="bg-card border border-border text-foreground p-2 rounded-lg hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Tebal"><i class="fa fa-bold" aria-hidden="true"></i></button>
                                <button type="button" data-cmd="italic" class="bg-card border border-border text-foreground p-2 rounded-lg hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Miring"><i class="fa fa-italic" aria-hidden="true"></i></button>
                                        <button type="button" data-cmd="heading" class="bg-card border border-border text-foreground p-2 rounded-lg hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Heading"><i class="fa fa-header" aria-hidden="true"></i></button>
                                <button type="button" data-cmd="quote" class="bg-card border border-border text-foreground p-2 rounded-lg hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Kutipan"><i class="fa fa-quote-left" aria-hidden="true"></i></button>
                                <button type="button" data-cmd="unordered-list" class="bg-card border border-border text-foreground p-2 rounded-lg hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Daftar tidak berurutan"><i class="fa fa-list-ul" aria-hidden="true"></i></button>
                                <button type="button" data-cmd="ordered-list" class="bg-card border border-border text-foreground p-2 rounded-lg hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Daftar berurutan"><i class="fa fa-list-ol" aria-hidden="true"></i></button>
                                <button type="button" data-cmd="link" onclick="window.openLinkInsertModal()" class="bg-card border border-border text-foreground p-2 rounded-lg hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Tautan"><i class="fa fa-link" aria-hidden="true"></i></button>
                                <button type="button" data-cmd="image" class="bg-card border border-border text-foreground p-2 rounded-lg hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Gambar"><i class="fa fa-image" aria-hidden="true"></i></button>
                                <button type="button" data-cmd="preview" class="bg-card border border-border text-foreground p-2 rounded-lg hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Pratinjau"><i class="fa fa-eye" aria-hidden="true"></i></button>
                                <button type="button" data-cmd="guide" class="bg-card border border-border text-foreground p-2 rounded-lg hover:bg-muted focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Panduan Markdown"><i class="fa fa-question-circle" aria-hidden="true"></i></button>
                                    </div>
                            <textarea id="story-content" name="content" class="custom-mde flex-1" placeholder="Mulai menulis cerita Anda di sini...\n\nTips:\n- Mulai dengan pengantar yang menarik\n- Gunakan heading untuk struktur\n- Tambahkan gambar untuk visual yang lebih baik\n- Gunakan daftar untuk informasi yang mudah dibaca" aria-label="Editor konten cerita"></textarea>
                        </div>
                        
                        <!-- Publication Section -->
                        <div class="mt-6 pt-4 border-t border-border">
                            <div class="bg-card border border-border rounded-xl shadow-sm overflow-hidden">
                                <div class="bg-gradient-to-r from-orange-50 to-red-50 px-6 py-4 border-b border-border">
                                                                            <h3 class="text-lg font-semibold text-foreground flex items-center">
                                            <i class="fas fa-rocket text-orange-600 mr-3"></i>
                                            Publikasi
                                        </h3>
                                    <p class="text-sm text-muted-foreground mt-1">Simpan atau terbitkan cerita</p>
                                </div>
                                <div class="p-6">
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <!-- Back Button -->
                                        <button type="button" id="prev-step-btn" class="bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-3 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300" aria-label="Kembali ke detail">
                                            <i class="fas fa-arrow-left mr-2"></i>Kembali ke Detail
                                        </button>
                                        
                                        <!-- Cancel Button -->
                                        <button type="button" id="cancel-edit-btn" class="bg-card hover:bg-muted text-foreground border border-border py-3 px-6 rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-muted transition-all duration-200" aria-label="Batal dan kembali">
                                            <i class="fas fa-times mr-2"></i>Batal
                                        </button>
                                        
                                        <!-- Save Hidden Button -->
                                        <button type="submit" name="save-draft" class="bg-muted hover:bg-muted/80 text-foreground border border-border py-3 px-6 rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-muted transition-all duration-200 flex items-center justify-center" aria-label="Simpan dan tetap sembunyi">
                                            <i class="fas fa-eye-slash mr-2"></i>Simpan Tersembunyi
                                        </button>
                                        
                                        <!-- Save and Show (Publish) Button -->
                                        <button type="submit" name="publish" class="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-200 flex items-center justify-center" aria-label="Simpan dan tampilkan ke publik">
                                            <i class="fas fa-eye mr-2"></i>Simpan & Tampilkan
                                        </button>
                                    </div>
                                    
                                    <!-- Help Text -->
                                    <div class="text-center pt-4 space-y-1">
                                        <p class="text-xs text-muted-foreground">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Pastikan field wajib telah diisi.
                                        </p>
                                        <p class="text-xs text-muted-foreground">
                                            <i class="fas fa-eye-slash mr-1"></i>
                                            <span>"Simpan Tersembunyi" menyimpan cerita tetapi tidak menampilkannya ke publik.</span>
                                        </p>
                                        <p class="text-xs text-muted-foreground">
                                            <span>"Simpan & Tampilkan" menyimpan dan langsung menampilkan cerita ke publik.</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Hidden input for news_id -->
<input type="hidden" id="news-id" value="{{ news_id or '' }}">

<!-- Modal Sisip Gambar untuk Tambah Cerita -->
<div id="image-insert-modal-create" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-40" role="dialog" aria-labelledby="image-insert-title" aria-modal="true">
  <div class="bg-white border border-gray-200 p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
    <h2 id="image-insert-title" class="text-xl font-semibold mb-4 text-gray-800">Sisipkan Gambar</h2>
    <div class="mb-4" role="radiogroup" aria-label="Pilih sumber gambar">
      <label class="inline-flex items-center"><input type="radio" name="image-source-create" value="library" checked class="form-radio text-blue-500" aria-label="Pilih dari perpustakaan"><span class="ml-2 text-gray-700">Perpustakaan</span></label>
      <label class="inline-flex items-center ml-4"><input type="radio" name="image-source-create" value="url" class="form-radio text-blue-500" aria-label="Gunakan URL eksternal"><span class="ml-2 text-gray-700">URL Eksternal</span></label>
    </div>
    <div id="image-library-section-create" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4 py-4" role="list" aria-label="Daftar gambar perpustakaan"></div>
    <!-- Pagination for Content Image Library (Create) -->
    <div id="content-image-pagination-controls-create" class="mt-4 mb-4" role="navigation" aria-label="Navigasi halaman gambar">
        <!-- Create content image pagination will be generated here -->
    </div>
    <div id="image-url-section-create" class="hidden space-y-4 mb-4">
      <input id="image-url-input-create" type="text" inputmode="url" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://contoh.com/gambar.jpg" aria-label="URL gambar">
      <input id="image-alt-input-create" type="text" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Alt teks (opsional)" aria-label="Teks alternatif gambar">
    </div>
    <div class="flex space-x-4" role="group" aria-label="Tombol aksi gambar">
      <button type="button" id="insert-image-btn-create" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300" aria-label="Sisipkan gambar">Sisipkan</button>
      <button type="button" id="close-image-insert-create" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all duration-300" aria-label="Tutup dialog">Tutup</button>
    </div>
  </div>
</div>

<!-- Modal Pilih Gambar Unggulan untuk Tambah Cerita -->
<div id="image-header-modal-create" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-40" role="dialog" aria-labelledby="header-image-title" aria-modal="true">
  <div class="bg-white border border-gray-200 p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
    <h2 id="header-image-title" class="text-xl font-semibold mb-4 text-gray-800">Pilih Gambar Unggulan</h2>
    <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg" role="group" aria-label="Unggah gambar baru">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold text-gray-800">Unggah Gambar Baru</h3>
        <a href="{{ url_for('user_profile.user_images', username=user.username) }}" 
           class="text-sm text-blue-600 hover:text-blue-800 flex items-center" 
           target="_blank">
          <i class="fas fa-cog mr-1"></i>Kelola Gambar
        </a>
      </div>
      <input id="header-upload-name-create" type="text" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nama gambar (opsional)" aria-label="Nama gambar">
      <input id="header-upload-file-create" type="file" accept="image/*" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" aria-label="Pilih file gambar">
      <input id="header-upload-url-create" type="url" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://contoh.com/gambar.jpg" aria-label="URL gambar">
      <button type="button" id="header-upload-btn-create" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300" aria-label="Unggah gambar">Unggah</button>
    </div>
    <div id="header-image-library-create" class="grid grid-cols-1 md:grid-cols-3 gap-6 py-4" role="list" aria-label="Daftar gambar unggulan"></div>
    <!-- Pagination for Header Image Library (Create) -->
    <div id="header-image-pagination-controls-create" class="mt-4 mb-4" role="navigation" aria-label="Navigasi halaman gambar unggulan">
        <!-- Create header image pagination will be generated here -->
    </div>
    <button type="button" id="header-image-close-create" onclick="console.log('Close button clicked via onclick'); window.closeImageHeaderModalCreate && window.closeImageHeaderModalCreate();" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg mt-4 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all duration-300" aria-label="Tutup dialog">Tutup</button>
  </div>
</div>

<!-- Modal Sisipkan Tautan -->
<div id="link-insert-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-30" role="dialog" aria-labelledby="link-insert-title" aria-modal="true">
    <div class="bg-white border border-gray-200 p-6 rounded-lg shadow-xl w-full max-w-md">
        <h3 id="link-insert-title" class="text-xl font-semibold text-gray-800 mb-4">Sisipkan Tautan</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-gray-700 font-medium mb-2" for="link-text">Teks Tautan</label>
                <input type="text" id="link-text" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="misalnya, Kunjungi situs kami" aria-label="Teks yang akan ditampilkan">
            </div>
            <div>
                <label class="block text-gray-700 font-medium mb-2" for="link-url">URL</label>
                <input type="text" inputmode="url" id="link-url" class="w-full bg-white border border-gray-300 text-gray-700 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., https://contoh.com" required aria-required="true" aria-label="URL tujuan">
            </div>
        </div>
        <div class="flex justify-end space-x-4 mt-6" role="group" aria-label="Tombol aksi tautan">
            <button type="button" id="cancel-link-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all duration-300" aria-label="Batal sisipkan tautan">Batal</button>
            <button type="button" id="insert-link-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300" aria-label="Sisipkan tautan">Sisipkan</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
{# Load dependent scripts first #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css">
<script src="{{ url_for('static', filename='js/toast.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>
{# Provide endpoint for user creation (used by news-create.js if present) #}
<script>
  window.NEWS_CREATE_ENDPOINT = '/api/user/news';
  window.CURRENT_USERNAME = '{{ user.username }}';
</script>
{# Load the main script for this page #}
<script src="{{ url_for('static', filename='js/news-create.js') }}"></script>

{# Custom CSS for better editor sizing #}
<style>
    /* Suppress expected console warnings */
    .suppress-warnings {
        /* This class is used to suppress expected console warnings */
    }
    
    /* Ensure SimpleMDE editor has proper height */
    /* Ensure SimpleMDE editor has proper height */
    .CodeMirror {
    min-height: 500px !important;
        height: auto !important;
        font-size: 16px !important;
        line-height: 1.6 !important;
    }
    
    /* Make the editor wrapper take full available height */
    #simplemde-wrapper {
        min-height: 600px !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    /* Ensure the textarea has proper height before SimpleMDE initializes */
    #story-content {
    min-height: 500px !important;
        font-size: 16px !important;
        line-height: 1.6 !important;
    }
    
    /* Make sure the editor grows to fill available space */
    .CodeMirror-scroll {
        min-height: 500px !important;
    }
    
    /* Ensure proper spacing in the content area */
    .CodeMirror-lines {
        padding: 20px !important;
    }

    /* Hide SimpleMDE default toolbar and statusbar to prevent conflicts with custom toolbar */
    /* Global hide as a safety net (SimpleMDE may insert toolbar outside our wrapper) */
    .editor-toolbar,
    .editor-statusbar,
    #simplemde-wrapper .editor-toolbar,
    #simplemde-wrapper .editor-statusbar {
        display: none !important;
    }

    /* Remove extra top spacing where the default toolbar would be */
    #simplemde-wrapper .CodeMirror {
        margin-top: 0 !important;
        background: transparent !important;
        border-color: var(--border);
    }

    #simplemde-wrapper .CodeMirror-scroll {
        background: transparent !important;
    }
</style>

{# Provide server data to JS without inline Jinja in JS code #}
<script id="news-meta" type="application/json">{{ news_id|default(None)|tojson }}</script>

<script>
// Ultra-early title prefill to avoid delays
(function() {
  try {
    const metaEl = document.getElementById('news-meta');
    if (!metaEl || !metaEl.textContent) return;
    const id = JSON.parse(metaEl.textContent);
    if (!id) return;
    fetch(`/api/news/${id}`).then(r => r.ok ? r.json() : null).then(a => {
      if (!a) return;
      const setIf = (el, val) => { if (el && val != null && String(val).length) el.value = val; };
      // Prefer visible story-title first so user sees it immediately
      const visibleTitle = document.getElementById('story-title') || document.getElementById('news-title');
      setIf(visibleTitle, a.title || '');
      // Keep hidden mapped title in sync if present
      const hiddenTitle = document.getElementById('news-title');
      if (hiddenTitle && hiddenTitle !== visibleTitle) setIf(hiddenTitle, a.title || '');
      // Also update header texts quickly
      const h1 = document.querySelector('h1.text-3xl'); if (h1) h1.textContent = 'Edit Cerita';
      const t2 = document.getElementById('create-story-title'); if (t2) t2.textContent = 'Edit Cerita';
    }).catch(()=>{});
  } catch(e) {}
})();
</script>

<script>
// Field ID mapping: map story-* IDs to news-* IDs so admin JS can work
// 
// Note: Some console warnings are expected and normal:
// - "cdn.tailwindcss.com should not be used in production" - This is expected in development
// - "SimpleMDE: Error. No element was found" - This resolves once SimpleMDE initializes
// - "Mobile menu elements not found" - This is expected if mobile menu isn't used on this page
// - "Force Scaling: Detected scale: 1" - This is informational, not an error
(function() {
    'use strict';
    
    // Wait for DOM to be ready
    function ready(fn) {
        if (document.readyState !== 'loading') {
            fn();
        } else {
            document.addEventListener('DOMContentLoaded', fn);
        }
    }
    
    ready(function() {
        console.log('Setting up field ID mapping for user story form...');
        
        // Map story-* field IDs to news-* IDs that the admin JS expects
        const fieldMappings = {
            'story-title': 'news-title',
            'story-category': 'news-category', 
            'story-tags': 'news-tagar',
            'story-writer': 'news-writer',
            'story-age-rating': 'news-age-rating',
            'story-external-source': 'news-external-source',
            'story-date': 'news-date',
            'story-content': 'news-content',
            'story-image-id': 'news-image-id'
        };
        
        // Create news-* fields and sync them with story-* fields
        Object.entries(fieldMappings).forEach(([storyId, newsId]) => {
            const storyField = document.getElementById(storyId);
            if (storyField) {
                // For the category field, we need to replace it entirely so admin JS can populate it
                if (storyId === 'story-category') {
                    // Clone the story field to create news-category
                    const newsField = storyField.cloneNode(true);
                    newsField.id = newsId;
                    newsField.name = 'category';
                    
                    // Replace the story field with the news field
                    storyField.parentNode.replaceChild(newsField, storyField);
                    
                    // Update the label to point to the new field
                    const label = document.querySelector(`label[for="${storyId}"]`);
                    if (label) {
                        label.setAttribute('for', newsId);
                    }
                    
                    console.log(`Replaced ${storyId} with ${newsId} for categories`);
                } else if (storyId === 'story-content') {
                    // For the content field, we need to replace it entirely so admin JS can initialize SimpleMDE
                    const newsField = storyField.cloneNode(true);
                    newsField.id = newsId;
                    newsField.name = 'content';
                    
                    // Replace the story field with the news field
                    storyField.parentNode.replaceChild(newsField, storyField);
                    
                    console.log(`Replaced ${storyId} with ${newsId} for content editor`);
                } else {
                    // For other fields, create hidden news fields and sync them
                    const newsField = document.createElement('input');
                    newsField.type = 'hidden';
                    newsField.id = newsId;
                    newsField.name = storyField.name;
                    newsField.value = storyField.value;
                    
                    // Insert after the story field
                    storyField.parentNode.insertBefore(newsField, storyField.nextSibling);
                    
                    // Sync values when story field changes
                    storyField.addEventListener('input', function() {
                        newsField.value = this.value;
                    });
                    
                    // Sync values when story field changes (for selects)
                    storyField.addEventListener('change', function() {
                        newsField.value = this.value;
                    });
                    
                    // For checkboxes, sync checked state
                    if (storyField.type === 'checkbox') {
                        storyField.addEventListener('change', function() {
                            newsField.value = this.checked ? 'true' : 'false';
                        });
                    }
                    
                    console.log(`Mapped ${storyId} -> ${newsId}`);
                }
            }
        });
        
        // Also map the form ID
        const storyForm = document.getElementById('create-story-form');
        if (storyForm) {
            storyForm.id = 'add-news-form';
            storyForm.setAttribute('novalidate', 'novalidate'); // disable native validation; we validate via JS
            console.log('Mapped form ID: create-story-form -> add-news-form (novalidate)');
        }
        
        // Map step indicators
        const step1Indicator = document.getElementById('step-1-indicator');
        const step2Indicator = document.getElementById('step-2-indicator');
        if (step1Indicator) step1Indicator.id = 'step-1-indicator';
        if (step2Indicator) step2Indicator.id = 'step-2-indicator';
        
        // Map step content divs
        const step1Content = document.getElementById('step-1-content');
        const step2Content = document.getElementById('step-2-content');
        if (step1Content) step1Content.id = 'step-1-content';
        if (step2Content) step2Content.id = 'step-2-content';
        
        // Map navigation buttons
        const nextStepBtn = document.getElementById('next-step-btn');
        const prevStepBtn = document.getElementById('prev-step-btn');
        if (nextStepBtn) nextStepBtn.id = 'next-step-btn';
        if (prevStepBtn) prevStepBtn.id = 'prev-step-btn';
        
        console.log('Field ID mapping complete - admin JS should now work with user form');
        
        // Prefill helper: wait for category select options to load
        async function waitForCategoryOptions(selectId = 'news-category', maxWaitMs = 2000) {
            const start = Date.now();
            return new Promise((resolve) => {
                const tick = () => {
                    const sel = document.getElementById(selectId);
                    if (sel && sel.options && sel.options.length > 1) {
                        resolve(sel);
                        return;
                    }
                    if (Date.now() - start > maxWaitMs) {
                        resolve(sel);
                        return;
                    }
                    setTimeout(tick, 100);
                };
                tick();
            });
        }

        // Cache and helpers for prefill
        function getNewsId() {
            const rawId = document.getElementById('news-id')?.value || null;
            const metaEl = document.getElementById('news-meta');
            let metaId = null;
            if (metaEl && metaEl.textContent) {
                try { metaId = JSON.parse(metaEl.textContent) || null; } catch (e) {}
            }
            return rawId || metaId;
        }
        let prefetchedArticle = null;
        async function fetchArticleFast(id) {
            if (prefetchedArticle) return prefetchedArticle;
            const resp = await fetch(`/api/news/${id}`);
            if (!resp.ok) return null;
            const data = await resp.json();
            prefetchedArticle = data;
            return data;
        }
        // Early prefill: set title and simple fields ASAP (no waiting)
        (async function earlyPrefill() {
            const newsId = getNewsId();
            if (!newsId) return;
            const a = await fetchArticleFast(newsId);
            if (!a) return;
            const setIf = (el, val) => { if (el && val != null && String(val).length) el.value = val; };
            // Title: set both possible IDs to avoid waiting for mapping
            setIf(document.getElementById('news-title') || document.getElementById('story-title'), a.title || '');
            setIf(document.getElementById('news-writer') || document.getElementById('story-writer'), a.writer || '');
            setIf(document.getElementById('news-tagar') || document.getElementById('story-tags'), a.tagar || '');
            setIf(document.getElementById('news-external-source') || document.getElementById('story-external-source'), a.external_source || '');
            if (a.date) setIf(document.getElementById('news-date') || document.getElementById('story-date'), a.date.substring(0,10));
            if (a.age_rating) setIf(document.getElementById('news-age-rating') || document.getElementById('story-age-rating'), a.age_rating);
        })();

        // Prefill form for edit mode (full prefill, runs after editor ready)
        async function prefillEditIfNeeded() {
            try {
                const newsId = getNewsId();
                if (!newsId) return; // create mode

                // Fetch data (use cache if available)
                const data = (prefetchedArticle) || await fetchArticleFast(newsId);
                if (!data) return;

                // Title (set both visible and hidden mapped fields)
                const storyTitleEl = document.getElementById('story-title');
                const newsTitleEl = document.getElementById('news-title');
                if (storyTitleEl && data.title) storyTitleEl.value = data.title;
                if (newsTitleEl && data.title) newsTitleEl.value = data.title;

                // Category (wait for options)
                const categoryEl = await waitForCategoryOptions('news-category');
                if (categoryEl && data.category_id) {
                    categoryEl.value = String(data.category_id);
                    const evt = new Event('change', { bubbles: true });
                    categoryEl.dispatchEvent(evt);
                }

                // Date (convert ISO to yyyy-mm-dd)
                const dateEl = document.getElementById('news-date');
                if (dateEl && data.date) {
                    try { dateEl.value = data.date.substring(0, 10); } catch (e) {}
                }

                // Age rating
                const ageEl = document.getElementById('news-age-rating');
                if (ageEl && data.age_rating) ageEl.value = data.age_rating;

                // Writer
                const writerEl = document.getElementById('news-writer');
                if (writerEl && data.writer) writerEl.value = data.writer;

                // External source
                const extEl = document.getElementById('news-external-source');
                if (extEl && data.external_source) extEl.value = data.external_source;

                // Tags
                const tagsEl = document.getElementById('news-tagar');
                if (tagsEl && data.tagar) tagsEl.value = data.tagar;


                // Featured image
                const imgIdInput = document.getElementById('news-image-id');
                const preview = document.getElementById('featured-preview-create');
                const noImagePlaceholder = document.getElementById('no-image-placeholder');
                if (data.header_image) {
                    if (imgIdInput && data.header_image.id) imgIdInput.value = data.header_image.id;
                    if (preview && data.header_image.url) {
                        preview.src = data.header_image.url;
                        preview.classList.remove('hidden');
                        if (noImagePlaceholder) noImagePlaceholder.classList.add('hidden');
                    }
                }

                // Content: wait for SimpleMDE, else fallback to textarea
                const setContent = () => {
                    const content = data.content || '';
                    // Try SimpleMDE
                    if (window.addSimplemde && window.addSimplemde.codemirror) {
                        try { window.addSimplemde.codemirror.setValue(content); return; } catch (e) {}
                    } else if (window.SimpleMDE && window.SimpleMDE.instances && window.SimpleMDE.instances.length > 0) {
                        try { window.SimpleMDE.instances[0].value(content); return; } catch (e) {}
                    }
                    // Fallback
                    const ta = document.getElementById('news-content') || document.getElementById('story-content');
                    if (ta) ta.value = content;
                };
                if (window.addSimplemde || (window.SimpleMDE && window.SimpleMDE.instances && window.SimpleMDE.instances.length > 0)) {
                    setContent();
                } else {
                    setTimeout(setContent, 300);
                }

                // Adjust header text for edit mode
                const h1 = document.querySelector('h1.text-3xl');
                if (h1) h1.textContent = 'Edit Cerita';
                const titleBlock = document.getElementById('create-story-title');
                if (titleBlock) titleBlock.textContent = 'Edit Cerita';
            } catch (e) {
                console.warn('Prefill edit failed:', e);
            }
        }

        // Step Navigation Logic (using the already declared variables)
        console.log('Setting up step navigation...');
        
        console.log('Step elements found:', {
            step1Content: !!step1Content,
            step2Content: !!step2Content,
            step1Indicator: !!step1Indicator,
            step2Indicator: !!step2Indicator,
            nextStepBtn: !!nextStepBtn,
            prevStepBtn: !!prevStepBtn
        });
        
        // Simple toast function
        function showToast(message, type = 'info') {
            console.log('Toast:', message, type);
            
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transform transition-all duration-300 translate-x-full`;
            
            switch (type) {
                case 'error':
                    toast.classList.add('bg-red-500');
                    break;
                case 'success':
                    toast.classList.add('bg-green-500');
                    break;
                case 'warning':
                    toast.classList.add('bg-yellow-500');
                    break;
                default:
                    toast.classList.add('bg-blue-500');
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // Step 1: Details (Default view)
        function showStep1() {
            console.log('Showing Step 1 (Details)');
            if (step1Content) step1Content.classList.remove('hidden');
            if (step2Content) step2Content.classList.add('hidden');
            
            if (step1Indicator) {
                step1Indicator.classList.remove('bg-gray-300', 'text-gray-600');
                step1Indicator.classList.add('bg-blue-600', 'text-white');
            }
            
            if (step2Indicator) {
                step2Indicator.classList.remove('bg-blue-600', 'text-white');
                step2Indicator.classList.add('bg-gray-300', 'text-gray-600');
            }
            
            // Update step labels
            const step1Label = document.querySelector('#step-1-indicator + span');
            const step2Label = document.querySelector('#step-2-indicator + span');
            
            if (step1Label) {
                step1Label.classList.remove('text-gray-500');
                step1Label.classList.add('text-gray-700');
            }
            
            if (step2Label) {
                step2Label.classList.remove('text-gray-700');
                step2Label.classList.add('text-gray-500');
            }
        }
        
        // Step 2: Content Editor
        function showStep2() {
            console.log('Showing Step 2 (Content)');
            
            // Validate required fields in step 1 (details)
            const titleInput = document.getElementById('news-title');
            const categoryInput = document.getElementById('news-category');
            const dateInput = document.getElementById('news-date');
            const ageRatingInput = document.getElementById('news-age-rating');
            
            const title = titleInput ? titleInput.value.trim() : '';
            const category = categoryInput ? categoryInput.value : '';
            const date = dateInput ? dateInput.value : '';
            const ageRating = ageRatingInput ? ageRatingInput.value : '';
            
            console.log('Validation check:', { 
                title: title, 
                category: category,
                date: date,
                ageRating: ageRating
            });
            
            if (!title) {
                showToast('Judul artikel harus diisi', 'error');
                if (titleInput) titleInput.focus();
                return;
            }
            
            if (!category) {
                showToast('Kategori harus dipilih', 'error');
                if (categoryInput) categoryInput.focus();
                return;
            }
            
            if (!date) {
                showToast('Tanggal publikasi harus diisi', 'error');
                if (dateInput) dateInput.focus();
                return;
            }
            
            if (!ageRating) {
                showToast('Rating usia konten harus dipilih', 'error');
                if (ageRatingInput) ageRatingInput.focus();
                return;
            }
            
            if (step1Content) step1Content.classList.add('hidden');
            if (step2Content) step2Content.classList.remove('hidden');
            
            if (step1Indicator) {
                step1Indicator.classList.remove('bg-blue-600', 'text-white');
                step1Indicator.classList.add('bg-gray-300', 'text-gray-600');
            }
            
            if (step2Indicator) {
                step2Indicator.classList.remove('bg-gray-300', 'text-gray-600');
                step2Indicator.classList.add('bg-blue-600', 'text-white');
            }
            
            // Update step labels
            const step1Label = document.querySelector('#step-1-indicator + span');
            const step2Label = document.querySelector('#step-2-indicator + span');
            
            if (step1Label) {
                step1Label.classList.remove('text-gray-700');
                step1Label.classList.add('text-gray-500');
            }
            
            if (step2Label) {
                step2Label.classList.remove('text-gray-500');
                step2Label.classList.add('text-gray-700');
            }
        }
        
        // Event listeners for step navigation
        if (nextStepBtn) {
            console.log('Adding click listener to next step button');
            nextStepBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Next step button clicked');
                showStep2();
            });
        } else {
            console.error('Next step button not found!');
        }
        
        if (prevStepBtn) {
            console.log('Adding click listener to prev step button');
            prevStepBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Prev step button clicked');
                showStep1();
            });
        } else {
            console.error('Prev step button not found!');
        }

        // Cancel button: go back to user stories page
        const cancelBtn = document.getElementById('cancel-edit-btn');
        if (cancelBtn) {
            console.log('Adding click listener to cancel button');
            cancelBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const fallbackUrl = '{{ url_for("user_profile.user_stories", username=user.username) }}';
                // Prefer going back if there is a referrer, otherwise go to user stories
                if (document.referrer && document.referrer !== window.location.href) {
                    try { window.history.back(); return; } catch (_) {}
                }
                window.location.href = fallbackUrl;
            });
        } else {
            console.error('Cancel button not found!');
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to go to next step (from details to content)
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                if (step1Content && !step1Content.classList.contains('hidden')) {
                    e.preventDefault();
                    showStep2();
                }
            }
        });
        
        console.log('Step navigation setup complete!');
        
        // Debug: Check if we're properly logged in and can access images
        console.log('Current user context:', {
            username: '{{ user.username }}',
            role: '{{ user.role }}',
            customRole: '{{ user.custom_role.name if user.custom_role else "None" }}'
        });
        
        // Completely replace the admin's image rendering with our robust version (set this early)
        console.log('Setting up custom renderImageLibraryCreate function...');
        window.renderImageLibraryCreate = function(images) {
            console.log('🎯 OUR CUSTOM renderImageLibraryCreate function called with', images?.length || 0, 'images');
            try {
                const container = document.getElementById('image-library-section-create');
                if (!container) {
                    console.warn('Image library container not found');
                    return;
                }
                
                if (!images || images.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <i class="fas fa-images text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-500 mb-2">Belum ada gambar</p>
                            <p class="text-sm text-gray-400">Upload gambar baru menggunakan form di atas</p>
                        </div>
                    `;
                return;
            }
            
                console.log('Rendering', images.length, 'images with our custom function');
                
                // Use our own robust rendering
                const imageHtml = images.map(img => {
                    // Debug the image object structure
                    console.log('Processing image in custom renderer:', img);
                    
                    // Try different possible URL field names
                    let imageUrl = img.url || img.image_url || img.file_url || img.path || img.filename;
                    let description = img.description || img.alt || img.name || img.title || 'Image';
                    
                    console.log('Extracted URL:', imageUrl, 'Description:', description);
                    
                    // Ensure we have a proper URL
                    if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                        imageUrl = '/' + imageUrl;
                    }
                    
                    // If still no valid URL, skip this image
                    if (!imageUrl || imageUrl === 'null' || imageUrl === 'undefined') {
                        console.warn('Skipping image with invalid URL:', img);
                        return '';
                    }
                    
                    console.log('Processing image:', img.id, 'Final URL:', imageUrl, 'Description:', description);
                    
                    return `
                        <div class="relative group cursor-pointer border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-200" 
                             onclick="window.insertImageFromLibrary('${imageUrl}', '${description}')">
                            <img src="${imageUrl}" alt="${description}" 
                                 class="w-full h-40 object-cover"
                                 onload="console.log('Image loaded successfully:', '${imageUrl}')"
                                 onerror="console.error('Image failed to load:', '${imageUrl}')">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
                                <span class="text-white opacity-0 group-hover:opacity-100 font-medium">Sisipkan</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('Setting container HTML with custom renderer');
                container.innerHTML = imageHtml;
                
                // Debug: check what's actually in the container
                    setTimeout(() => {
                    console.log('Container after custom rendering:', container.innerHTML.substring(0, 200));
                    const images = container.querySelectorAll('img');
                    console.log('Found', images.length, 'img elements in container with custom renderer');
                    }, 100);
                    
            } catch (error) {
                console.error('Error in custom renderImageLibraryCreate:', error);
                const container = document.getElementById('image-library-section-create');
                if (container) {
                    container.innerHTML = '<p class="col-span-full text-center text-red-500 py-4">Error rendering images.</p>';
                }
            }
        };
        
        // Override the admin's image loading functions to ensure user-appropriate images only
        window.fetchAndDisplayContentImagesCreate = async function(page = 1) {
            console.log('User-specific content images loading...');
            const librarySection = document.getElementById('image-library-section-create');
            const paginationContainer = document.getElementById('content-image-pagination-controls-create');
            if (!librarySection || !paginationContainer) return;
            
            librarySection.innerHTML = '<p class="col-span-full text-center text-gray-500 py-4">Loading your images...</p>';
            paginationContainer.innerHTML = '';
            
            try {
                // Call the API with all_users=true to get all images (visible and hidden) owned by the user
                const response = await fetch(`/api/images?page=${page}&per_page=12&all_users=true`);
                if (!response.ok) throw new Error('Failed to load content images');
                const data = await response.json();
                console.log('User content images loaded:', data.items.length, 'images (visible and hidden) with ownership filtering');
                
                // Show message if no images found
                if (data.items.length === 0) {
                    librarySection.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <i class="fas fa-images text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-500 mb-2">Belum ada gambar</p>
                            <p class="text-sm text-gray-400">Upload gambar baru menggunakan form di atas</p>
                        </div>
                    `;
                } else {
                    // Use the admin's rendering function but with our data
                    if (window.renderImageLibraryCreate) {
                        window.renderImageLibraryCreate(data.items);
                        if (window.updateContentImagePaginationControlsCreate) {
                            window.updateContentImagePaginationControlsCreate(data);
                        }
                    }
                }
            } catch (err) {
                librarySection.innerHTML = '<p class="col-span-full text-red-500 py-4">Error loading images.</p>';
                console.error("Content image load error (user):", err);
            }
        };
        
        window.loadHeaderLibraryCreate = async function(page = 1) {
            console.log('User-specific header images loading...');
            const container = document.getElementById('header-image-library-create');
            const paginationContainer = document.getElementById('header-image-pagination-controls-create');
            if (!container || !paginationContainer) return;

            container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-4">Loading your images...</p>';
            paginationContainer.innerHTML = '';

            try {
                // Try to get ALL images (visible and hidden) owned by the user using different API parameters
                console.log('Attempting to get all images (visible and hidden) owned by the user...');
                
                // First try: request all images without visibility filtering
                const response = await fetch(`/api/images?page=${page}&per_page=50&all_users=true`);
                if (response.ok) {
                    const data = await response.json();
                    const imgs = data.items || [];
                    console.log('Successfully got all images (visible and hidden):', imgs.length, 'images owned by the user');
                    return data;
                }
                
                // Second try: request without all_users parameter (should still get user's own images)
                console.log('First attempt failed, trying without all_users parameter...');
                const response2 = await fetch(`/api/images?page=${page}&per_page=50`);
                if (response2.ok) {
                    const data = await response2.json();
                    const imgs = data.items || [];
                    console.log('Successfully got user images:', imgs.length, 'images owned by the user');
                    return data;
                }
                
                // Third try: request with all_users=true (should get all user's images)
                console.log('Second attempt failed, trying with all_users=true...');
                const response3 = await fetch(`/api/images?page=${page}&per_page=50&all_users=true`);
                if (response3.ok) {
                    const data = await response3.json();
                    const imgs = data.items || [];
                    console.log('Got all user images with all_users=true:', imgs.length, 'total images');
                    
                    // Return all images (no filtering needed - we want both visible and hidden)
                    return data;
                }
                
                // Final fallback: use endpoint with all_users=true (no visibility filter)
                console.log('All attempts failed, using fallback endpoint with all_users=true...');
                const fallbackResponse = await fetch(`/api/images?page=${page}&per_page=12&all_users=true`);
                if (!fallbackResponse.ok) throw new Error('Failed to load header images');
                const fallbackData = await fallbackResponse.json();
                console.log('Using fallback endpoint with all_users=true, found:', fallbackData.items.length, 'images');
                return fallbackData;
                
            } catch (err) {
                console.error('Error loading header images:', err);
                throw err;
            }
        };
        
        // New function to actually load and display the images
        window.loadAndDisplayHeaderImages = async function(page = 1) {
            console.log('Loading and displaying header images...');
            const container = document.getElementById('header-image-library-create');
            const paginationContainer = document.getElementById('header-image-pagination-controls-create');
            if (!container || !paginationContainer) return;

            container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-4">Loading your images...</p>';
            paginationContainer.innerHTML = '';

            try {
                const data = await window.loadHeaderLibraryCreate(page);
                const imgs = data.items || [];
                console.log('Images loaded:', imgs.length, 'total images');
                console.log('Full API response:', data);
                console.log('Images array:', imgs);
                
                if (imgs.length > 0) {
                    console.log('First image object:', imgs[0]);
                    console.log('First image keys:', Object.keys(imgs[0]));
                    console.log('First image values:', Object.values(imgs[0]));
                }

                // Always use our own fallback rendering for featured images to ensure reliability
                console.log('Using our own rendering for featured images');
                if (imgs.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <i class="fas fa-images text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-500 mb-2">Belum ada gambar</p>
                            <p class="text-sm text-gray-400">Upload gambar baru menggunakan form di atas</p>
                        </div>
                    `;
                    } else {
                    console.log('Rendering', imgs.length, 'images to container');
                    
                    const imageHtml = imgs.map(img => {
                        // Debug the image object structure
                        console.log('Raw image object:', img);
                        
                        // Try different possible URL field names
                        let imageUrl = img.url || img.image_url || img.file_url || img.path || img.filename;
                        let description = img.description || img.alt || img.name || img.title || 'Image';
                        
                        console.log('Extracted URL:', imageUrl, 'Description:', description);
                        
                        // Ensure we have a proper URL
                        if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/')) {
                            imageUrl = '/' + imageUrl;
                        }
                        
                        // If still no valid URL, skip this image
                        if (!imageUrl || imageUrl === 'null' || imageUrl === 'undefined') {
                            console.warn('Skipping image with invalid URL:', img);
                            return '';
                        }
                        
                        console.log('Processing image:', img.id, 'Final URL:', imageUrl, 'Description:', description);
                        
                        return `
                            <div class="relative group cursor-pointer border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-200" 
                                 onclick="selectHeaderImage('${imageUrl}', ${img.id})">
                                <img src="${imageUrl}" alt="${description}" 
                                     class="w-full h-40 object-cover"
                                     onload="console.log('Image loaded successfully:', '${imageUrl}')"
                                     onerror="console.error('Image failed to load:', '${imageUrl}')">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
                                    <span class="text-white opacity-0 group-hover:opacity-100 font-medium">Pilih</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    console.log('Setting container HTML:', imageHtml.substring(0, 100) + '...');
                    container.innerHTML = imageHtml;
                    console.log('Container HTML set, current innerHTML length:', container.innerHTML.length);
                    
                    // Debug: check what's actually in the container
                    setTimeout(() => {
                        console.log('Container after rendering:', container.innerHTML.substring(0, 200));
                        const images = container.querySelectorAll('img');
                        console.log('Found', images.length, 'img elements in container');
                        images.forEach((img, index) => {
                            console.log(`Image ${index}:`, img.src, img.alt);
                            console.log(`Image ${index} natural dimensions:`, img.naturalWidth, 'x', img.naturalHeight);
                            console.log(`Image ${index} current dimensions:`, img.width, 'x', img.height);
                            console.log(`Image ${index} complete:`, img.complete);
                            console.log(`Image ${index} readyState:`, img.readyState);
                        });
                        
                        // Check if images are actually visible
                        const imageContainers = container.querySelectorAll('.relative.group.cursor-pointer');
                        console.log('Found', imageContainers.length, 'image containers');
                        imageContainers.forEach((container, index) => {
                            const rect = container.getBoundingClientRect();
                            console.log(`Container ${index} dimensions:`, rect.width, 'x', rect.height);
                            console.log(`Container ${index} visible:`, rect.width > 0 && rect.height > 0);
                        });
                    }, 100);
                    
                    // Add pagination controls
                    if (data.total_pages > 1) {
                        console.log('Adding pagination controls for', data.total_pages, 'pages');
                        const paginationHtml = generatePaginationControls(data, page);
                        paginationContainer.innerHTML = paginationHtml;
                    }
                }
            } catch (err) {
                console.error('Error loading header images:', err);
                container.innerHTML = '<p class="col-span-full text-center text-red-500 py-4">Error loading images.</p>';
            }
        };
        
        // Function to generate pagination controls
        function generatePaginationControls(data, currentPage) {
            const totalPages = data.total_pages;
            const totalItems = data.total_items;
            const perPage = data.per_page;
            
            let paginationHtml = `
                <div class="flex items-center justify-between text-sm text-gray-700 mb-4">
                    <div>
                        Showing ${((currentPage - 1) * perPage) + 1} to ${Math.min(currentPage * perPage, totalItems)} of ${totalItems} images
                    </div>
                    <div class="flex space-x-2">
            `;
            
            // Previous button
            if (currentPage > 1) {
                paginationHtml += `
                    <button onclick="window.loadAndDisplayHeaderImages(${currentPage - 1})" 
                            class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                        <i class="fas fa-chevron-left mr-1"></i>Previous
                    </button>
                `;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHtml += `
                        <span class="px-3 py-2 bg-blue-600 text-white rounded-lg">${i}</span>
                    `;
                } else {
                    paginationHtml += `
                        <button onclick="window.loadAndDisplayHeaderImages(${i})" 
                                class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                            ${i}
                        </button>
                    `;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHtml += `
                    <button onclick="window.loadAndDisplayHeaderImages(${currentPage + 1})" 
                            class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors">
                        Next<i class="fas fa-chevron-right ml-1"></i>
                    </button>
                `;
            }
            
            paginationHtml += `
                    </div>
                </div>
            `;
            
            return paginationHtml;
        }


        
        // Helper functions for image selection
        window.insertImageFromLibrary = function(imageUrl, altText) {
            console.log('🎯 insertImageFromLibrary called with:', imageUrl, altText);
            
            // Try multiple ways to get the SimpleMDE editor
            let cm = null;
            let simplemde = null;
            
            // Method 1: Check if addSimplemde is available
            if (window.addSimplemde) {
                if (window.addSimplemde.codemirror) {
                    cm = window.addSimplemde.codemirror;
                    simplemde = window.addSimplemde;
                    console.log('Found editor via addSimplemde.codemirror');
                } else if (window.addSimplemde.simplemde && window.addSimplemde.simplemde.codemirror) {
                    cm = window.addSimplemde.simplemde.codemirror;
                    simplemde = window.addSimplemde.simplemde;
                    console.log('Found editor via addSimplemde.simplemde.codemirror');
                }
            }
            
            // Method 2: Check global SimpleMDE instances
            if (!cm && window.SimpleMDE && window.SimpleMDE.instances && window.SimpleMDE.instances.length > 0) {
                cm = window.SimpleMDE.instances[0].codemirror;
                simplemde = window.SimpleMDE.instances[0];
                console.log('Found editor via SimpleMDE.instances[0]');
            }
            
            // Method 3: Check if there's a textarea we can work with directly
            if (!cm) {
                const textarea = document.getElementById('news-content') || document.getElementById('story-content');
                if (textarea) {
                    console.log('Found textarea, inserting markdown directly');
                    const markdown = `![${altText || 'Image'}](${imageUrl})`;
                    const cursorPos = textarea.selectionStart;
                    const textBefore = textarea.value.substring(0, cursorPos);
                    const textAfter = textarea.value.substring(cursorPos);
                    textarea.value = textBefore + markdown + textAfter;
                    
                    // Set cursor position after the inserted markdown
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + markdown.length;
                    
                    // Trigger input event to notify any listeners
                    textarea.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    // Close the modal
                    const modal = document.getElementById('image-insert-modal-create');
                    if (modal) modal.classList.add('hidden');
                    
                    console.log('✅ Image markdown inserted directly into textarea');
                    return;
                }
            }
            
            // Method 4: Try to use the editor if we found it
            if (cm) {
                try {
                    const markdown = `![${altText || 'Image'}](${imageUrl})`;
                    cm.replaceSelection(markdown);
                    console.log('✅ Image markdown inserted via CodeMirror');
                    
                    // Close the modal
                    const modal = document.getElementById('image-insert-modal-create');
                    if (modal) modal.classList.add('hidden');
        } catch (error) {
                    console.error('Error inserting via CodeMirror:', error);
                    // Fallback to textarea method
                    const textarea = document.getElementById('news-content') || document.getElementById('story-content');
                    if (textarea) {
                        const markdown = `![${altText || 'Image'}](${imageUrl})`;
                        const cursorPos = textarea.selectionStart;
                        const textBefore = textarea.value.substring(0, cursorPos);
                        const textAfter = textarea.value.substring(cursorPos);
                        textarea.value = textBefore + markdown + textAfter;
                        textarea.selectionStart = textarea.selectionEnd = cursorPos + markdown.length;
                        textarea.dispatchEvent(new Event('input', { bubbles: true }));
                        
                        const modal = document.getElementById('image-insert-modal-create');
                        if (modal) modal.classList.add('hidden');
                        
                        console.log('✅ Image markdown inserted via fallback textarea method');
                    }
                }
        } else {
                console.warn('❌ No editor or textarea found, cannot insert image');
                // Show user feedback
                alert('Tidak dapat menyisipkan gambar. Silakan salin URL gambar dan sisipkan secara manual.');
            }
        };
        
        window.selectHeaderImage = function(imageUrl, imageId) {
            console.log('Selected header image:', imageUrl, 'ID:', imageId);
            // Update the featured image preview
            const preview = document.getElementById('featured-preview-create');
            const noImagePlaceholder = document.getElementById('no-image-placeholder');
            const imageIdInput = document.getElementById('news-image-id');
            
            if (preview) {
                preview.src = imageUrl;
                preview.classList.remove('hidden');
            }
            if (noImagePlaceholder) {
                noImagePlaceholder.classList.add('hidden');
            }
            if (imageIdInput) {
                imageIdInput.value = imageId;
            }
            
            // Close the modal
            const modal = document.getElementById('image-header-modal-create');
            if (modal) modal.classList.add('hidden');
        };
        
        // Override the admin's modal opening functions to ensure images load
        window.openImageHeaderModalCreate = function() {
            console.log('Opening featured image modal...');
            const modal = document.getElementById('image-header-modal-create');
            if (modal) {
                modal.classList.remove('hidden');
                // Load images immediately when modal opens
                setTimeout(() => {
                    if (window.loadAndDisplayHeaderImages) {
                        window.loadAndDisplayHeaderImages(1);
                    } else if (window.loadHeaderLibraryCreate) {
                        window.loadHeaderLibraryCreate(1);
                    }
                }, 100);
            }
        };
        
        window.closeImageHeaderModalCreate = function() {
            console.log('Closing featured image modal...');
            const modal = document.getElementById('image-header-modal-create');
            if (modal) {
                modal.classList.add('hidden');
            }
        };
        
        // Ensure the form action includes proper user context
        const form = document.getElementById('add-news-form');
        if (form) {
            // Add a hidden input to ensure user context is preserved
            const userContextInput = document.createElement('input');
            userContextInput.type = 'hidden';
            userContextInput.name = 'user_context';
            userContextInput.value = '{{ user.username }}';
            form.appendChild(userContextInput);
            console.log('Added user context to form');
        }
        
        // Wait for SimpleMDE to be properly initialized
        function waitForSimpleMDE(callback, maxAttempts = 100) {
            let attempts = 0;
            const checkInterval = setInterval(() => {
                attempts++;
                
                // Check if SimpleMDE is available
                if (window.addSimplemde && window.addSimplemde.codemirror) {
                    clearInterval(checkInterval);
                    console.log('✅ SimpleMDE found after', attempts, 'attempts via addSimplemde.codemirror');
                    callback();
                } else if (window.addSimplemde && window.addSimplemde.simplemde && window.addSimplemde.simplemde.codemirror) {
                    clearInterval(checkInterval);
                    console.log('✅ SimpleMDE found after', attempts, 'attempts via addSimplemde.simplemde.codemirror');
                    callback();
                } else if (window.SimpleMDE && window.SimpleMDE.instances && window.SimpleMDE.instances.length > 0) {
                    clearInterval(checkInterval);
                    console.log('✅ SimpleMDE instances found after', attempts, 'attempts');
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.warn('⚠️ SimpleMDE not found after', maxAttempts, 'attempts - will use fallback methods');
                    callback(); // Still call callback to initialize fallback functionality
                }
                
                // Log progress every 10 attempts
                if (attempts % 10 === 0) {
                    console.log(`Checking SimpleMDE... attempt ${attempts}/${maxAttempts}`);
                }
            }, 100);
        }
        
                // Initialize SimpleMDE-dependent functionality
        waitForSimpleMDE(() => {
            console.log('SimpleMDE is ready, initializing image functionality...');
            // After editor ready, attempt prefill if editing
            prefillEditIfNeeded();
            
            // Our custom renderImageLibraryCreate function is already defined above
            console.log('Custom image rendering function is ready');
            
            // Test image insertion functionality
            console.log('Testing image insertion methods...');
            
            // Check what's available
            if (window.addSimplemde && window.addSimplemde.codemirror) {
                console.log('✅ addSimplemde.codemirror available');
            } else if (window.addSimplemde && window.addSimplemde.simplemde) {
                console.log('✅ addSimplemde.simplemde available');
            } else if (window.SimpleMDE && window.SimpleMDE.instances) {
                console.log('✅ SimpleMDE.instances available:', window.SimpleMDE.instances.length);
                } else {
                console.log('⚠️ No SimpleMDE found, will use textarea fallback');
            }
            
            // Check if textarea is available as fallback
            const textarea = document.getElementById('news-content') || document.getElementById('story-content');
            if (textarea) {
                console.log('✅ Textarea fallback available:', textarea.id);
                    } else {
                console.log('❌ No textarea fallback available');
            }
        });
        
        // Add link modal functionality that doesn't depend on SimpleMDE
        window.openLinkInsertModal = function() {
            console.log('🔗 openLinkInsertModal called');
            const modal = document.getElementById('link-insert-modal');
            if (modal) {
                console.log('✅ Link modal found, showing it');
                modal.classList.remove('hidden');
                // Focus on the link text input
                const linkTextInput = document.getElementById('link-text');
                if (linkTextInput) {
                    linkTextInput.focus();
                    console.log('✅ Link text input focused');
                        } else {
                    console.warn('❌ Link text input not found');
                        }
                    } else {
                console.error('❌ Link modal not found');
            }
        };
        
        window.insertLink = function() {
            console.log('🔗 insertLink called');
            const linkText = document.getElementById('link-text')?.value.trim();
            const linkUrl = document.getElementById('link-url')?.value.trim();
            
            console.log('Link text:', linkText, 'Link URL:', linkUrl);
            
            if (!linkUrl) {
                alert('URL harus diisi');
                return;
            }
            
            // Try to insert into SimpleMDE
            let cm = null;
            if (window.addSimplemde && window.addSimplemde.codemirror) {
                cm = window.addSimplemde.codemirror;
            } else if (window.SimpleMDE && window.SimpleMDE.instances && window.SimpleMDE.instances.length > 0) {
                cm = window.SimpleMDE.instances[0].codemirror;
            }
            
            if (cm) {
                const markdown = linkText ? `[${linkText}](${linkUrl})` : `[${linkUrl}](${linkUrl})`;
                cm.replaceSelection(markdown);
                } else {
                console.warn('SimpleMDE not available, cannot insert link');
            }
            
            // Close modal
            const modal = document.getElementById('link-insert-modal');
            if (modal) modal.classList.add('hidden');
            
            // Clear inputs
            if (document.getElementById('link-text')) document.getElementById('link-text').value = '';
            if (document.getElementById('link-url')) document.getElementById('link-url').value = '';
        };
        
        // Add event listeners for link modal
        function setupLinkModalListeners() {
            console.log('🔗 Setting up link modal event listeners...');
            
            const insertLinkBtn = document.getElementById('insert-link-btn');
            const cancelLinkBtn = document.getElementById('cancel-link-btn');
            const closeImageInsertBtn = document.getElementById('close-image-insert-create');
            
            if (insertLinkBtn) {
                insertLinkBtn.addEventListener('click', window.insertLink);
                console.log('✅ Insert link button listener added');
            } else {
                console.warn('❌ Insert link button not found');
            }
            
            if (cancelLinkBtn) {
                cancelLinkBtn.addEventListener('click', function() {
                    const modal = document.getElementById('link-insert-modal');
                    if (modal) modal.classList.add('hidden');
                    console.log('🔗 Link modal closed via cancel button');
                });
                console.log('✅ Cancel link button listener added');
                    } else {
                console.warn('❌ Cancel link button not found');
            }
            
            if (closeImageInsertBtn) {
                closeImageInsertBtn.addEventListener('click', function() {
                    const modal = document.getElementById('image-insert-modal-create');
                    if (modal) modal.classList.add('hidden');
                    console.log('🖼️ Image insert modal closed');
                });
                console.log('✅ Close image insert button listener added');
            } else {
                console.warn('❌ Close image insert button not found');
            }
        }
        
        // Set up listeners when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupLinkModalListeners);
                            } else {
            setupLinkModalListeners();
        }
        
        // Check if admin functions are available and log status
        setTimeout(() => {
            console.log('Checking admin image functions availability:');
            console.log('- renderImageLibraryCreate:', !!window.renderImageLibraryCreate);
            console.log('- renderHeaderLibraryCreate:', !!window.renderHeaderLibraryCreate);
            console.log('- updateContentImagePaginationControlsCreate:', !!window.updateContentImagePaginationControlsCreate);
            console.log('- updateHeaderImagePaginationControlsCreate:', !!window.updateHeaderImagePaginationControlsCreate);
            
            // Test image loading directly
            console.log('Testing image loading directly...');
            if (window.loadHeaderLibraryCreate) {
                window.loadHeaderLibraryCreate(1);
            } else {
                console.log('loadHeaderLibraryCreate not available, testing API call directly...');
                // Test the API call directly
                fetch('/api/images?page=1&per_page=12&all_users=true')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Direct API test successful:', data.items.length, 'images found');
                        const container = document.getElementById('header-image-library-create');
                        if (container && data.items.length > 0) {
                            container.innerHTML = data.items.map(img => `
                                <div class="relative group cursor-pointer border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-200" 
                                     onclick="selectHeaderImage('${img.url}', ${img.id})">
                                    <img src="${img.url}" alt="${img.description || 'Image'}" 
                                         class="w-full h-32 object-cover">
                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
                                        <span class="text-white opacity-0 group-hover:opacity-100 font-medium">Pilih</span>
                                    </div>
                                </div>
                            `).join('');
                        } else if (container) {
                            container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-4">No images found</p>';
                        }
                    })
                    .catch(err => {
                        console.error('Direct API test failed:', err);
                    });
            }
        }, 2000);
    });
})();
</script>
{% endblock %}