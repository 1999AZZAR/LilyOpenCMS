{% extends 'base.html' %}

{% block title %}{{ user.get_full_name() or user.username }} - Profil{% endblock %}

{% block content %}
<div class="min-h-screen bg-background">
    <!-- Profile Header -->
    <div class="bg-card border-b border-border">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex items-start space-x-6">
                <!-- Profile Picture -->
                <div class="flex-shrink-0">
                    <div class="w-24 h-24 rounded-full bg-muted flex items-center justify-center">
                        {% if user.profile_picture %}
                            <img src="{{ user.profile_picture }}" alt="{{ user.username }}" class="w-24 h-24 rounded-full object-cover">
                        {% else %}
                            <i class="fas fa-user text-3xl text-muted-foreground"></i>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Profile Info -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold text-foreground">{{ user.get_full_name() or user.username }}</h1>
                            {% if profile.pronouns %}
                                <p class="text-sm text-muted-foreground mt-1">{{ profile.pronouns }}</p>
                            {% endif %}
                            <p class="text-sm text-muted-foreground mt-1">Bergabung {{ user.created_at.strftime('%B %Y') if user.created_at else 'Tidak Diketahui' }}</p>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <a href="{{ url_for('main.home') }}" 
                               class="text-primary hover:text-foreground transition-colors">
                                <i class="fas fa-home mr-2"></i>Kembali ke Beranda
                            </a>
                            
                            <!-- Follow Button -->
                            {% if current_user.is_authenticated and current_user.id != user.id %}
                                <button id="follow-btn" 
                                        data-user-id="{{ user.id }}" 
                                        data-following="{{ 'true' if is_following else 'false' }}"
                                        class="{% if is_following %}button button-outline{% else %}button button-primary{% endif %}">
                                    {% if is_following %}
                                        <i class="fas fa-check mr-2"></i>Mengikuti
                                    {% else %}
                                        <i class="fas fa-plus mr-2"></i>Ikuti
                                    {% endif %}
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if profile.short_bio %}
                        <p class="text-foreground mt-3">{{ profile.short_bio }}</p>
                    {% endif %}
                    
                    <!-- Stats -->
                    <div class="flex items-center space-x-6 mt-4 text-sm text-muted-foreground">
                        <span><strong>{{ stats.total_stories }}</strong> cerita</span>
                        <span><strong>{{ stats.total_albums }}</strong> album</span>
                        <span><strong data-follower-count>{{ stats.total_followers }}</strong> pengikut</span>
                        <span><strong>{{ stats.total_following }}</strong> mengikuti</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation Tabs -->
    <div class="bg-card border-b border-border">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex flex-wrap gap-6">
                <a href="{{ url_for('user_profile.user_profile', username=user.username, tab='home') }}" 
                   class="py-4 px-1 border-b-2 font-medium text-sm {% if active_tab == 'home' %}border-primary text-primary{% else %}border-transparent text-muted-foreground hover:text-foreground hover:border-border{% endif %}">Beranda</a>
                <a href="{{ url_for('user_profile.user_library', username=user.username) }}" class="py-4 px-1 border-b-2 font-medium text-sm border-transparent text-muted-foreground hover:text-foreground hover:border-border">Perpustakaan</a>
                
                <!-- Show Stories tab only if user has write access or is admin -->
                {% if has_write_access(user) %}
                    <a href="{{ url_for('user_profile.user_stories', username=user.username) }}" class="py-4 px-1 border-b-2 font-medium text-sm border-transparent text-muted-foreground hover:text-foreground hover:border-border">Cerita</a>
                {% endif %}
                
                <!-- Show List tab only if user has write access or is admin -->
                {% if has_write_access(user) %}
                    <a href="{{ url_for('user_profile.user_profile', username=user.username, tab='list') }}" 
                       class="py-4 px-1 border-b-2 font-medium text-sm {% if active_tab == 'list' %}border-primary text-primary{% else %}border-transparent text-muted-foreground hover:text-foreground hover:border-border{% endif %}">Album</a>
                {% endif %}
                
                <a href="{{ url_for('user_profile.user_stats', username=user.username) }}" class="py-4 px-1 border-b-2 font-medium text-sm border-transparent text-muted-foreground hover:text-foreground hover:border-border">Statistik</a>
                <a href="{{ url_for('user_profile.user_following', username=user.username) }}" class="py-4 px-1 border-b-2 font-medium text-sm border-transparent text-muted-foreground hover:text-foreground hover:border-border">Mengikuti</a>
                {% if current_user.is_authenticated and current_user.id == user.id %}
                    <a href="{{ url_for('user_profile.user_settings', username=user.username) }}" class="py-4 px-1 border-b-2 font-medium text-sm border-transparent text-muted-foreground hover:text-foreground hover:border-border">Pengaturan</a>
                {% endif %}
            </nav>
        </div>
    </div>
    
    <!-- Tab Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% if active_tab == 'list' %}
            {% include 'public/user/profile_list.html' %}
        {% else %}
            <!-- Default content for home tab -->
            <div class="space-y-8">
                <div class="text-center py-12">
                    <i class="fas fa-home text-4xl text-muted-foreground mb-4"></i>
                    <p class="text-muted-foreground">Selamat datang di profil {{ user.get_full_name() or user.username }}</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Follow/Unfollow functionality
    const followBtn = document.getElementById('follow-btn');
    if (followBtn) {
        followBtn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const isFollowing = this.dataset.following === 'true';
            
            fetch(`/api/follow/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button state
                    if (data.action === 'followed') {
                        this.innerHTML = '<i class="fas fa-check mr-2"></i>Mengikuti';
                        this.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                        this.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                        this.dataset.following = 'true';
                    } else {
                        this.innerHTML = '<i class="fas fa-plus mr-2"></i>Ikuti';
                        this.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                        this.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                        this.dataset.following = 'false';
                    }
                    
                    // Update follower count
                    const followerCount = document.querySelector('[data-follower-count]');
                    if (followerCount) {
                        followerCount.textContent = data.follower_count;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    }
});
</script>
{% endblock %}