{% extends 'base.html' %}

{% block title %}Perpustakaan - {{ user.get_full_name() or user.username }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-background">
    <!-- Header -->
    <div class="bg-card border-b border-border">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-foreground">Perpustakaan</h1>
                    <p class="mt-2 text-muted-foreground">Perpustakaan {{ user.get_full_name() or user.username }}</p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('user_profile.user_profile', username=user.username) }}" 
                       class="text-primary hover:text-foreground">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali ke Profil
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Status Tabs -->
        <div class="flex items-center justify-between border-b border-border mb-6">
            <nav class="flex space-x-8" aria-label="Library tabs">
                <button id="your-list-tab" 
                        class="py-2 px-1 border-b-2 font-medium text-sm {% if active_tab == 'your-list' %}border-primary text-primary{% else %}border-transparent text-muted-foreground hover:text-foreground hover:border-border{% endif %}">
                    Daftar Anda ({{ own_albums|length }})
                </button>
                <button id="saved-list-tab" 
                        class="py-2 px-1 border-b-2 font-medium text-sm {% if active_tab == 'saved-list' %}border-primary text-primary{% else %}border-transparent text-muted-foreground hover:text-foreground hover:border-border{% endif %}">
                    Daftar Tersimpan ({{ library_items|length }})
                </button>
                <button id="reading-history-tab" 
                        class="py-2 px-1 border-b-2 font-medium text-sm {% if active_tab == 'reading-history' %}border-primary text-primary{% else %}border-transparent text-muted-foreground hover:text-foreground hover:border-border{% endif %}">
                    Riwayat Membaca ({{ reading_history|length }})
                </button>
                <button id="response-tab" 
                        class="py-2 px-1 border-b-2 font-medium text-sm {% if active_tab == 'response' %}border-primary text-primary{% else %}border-transparent text-muted-foreground hover:text-foreground hover:border-border{% endif %}">
                    Tanggapan
                </button>
            </nav>
        </div>

        <!-- Your List Tab -->
        <div id="your-list-content" class="space-y-6 {% if active_tab != 'your-list' %}hidden{% endif %}">
            {% if own_albums %}
                <div class="space-y-6">
                    {% for album in own_albums %}
                        <article class="bg-card rounded-lg shadow-sm border border-border overflow-hidden transition-all duration-300 hover:border-primary/30 hover:shadow-lg group">
                            <div class="flex flex-col sm:flex-row">
                                <!-- Image Container -->
                                <div class="sm:w-1/3 lg:w-2/5 xl:w-1/3 flex-shrink-0 bg-secondary overflow-hidden aspect-video sm:aspect-auto">
                                    <a href="{{ url_for('main.album_detail', album_id=album.id, album_title='album') }}" class="block h-full" aria-label="View album: {{ album.title | e }}">
                                        {% if album.cover_image_id %}
                                            <img src="{{ url_for('static', filename='uploads/' + album.cover_image.filename) }}" 
                                                 alt="{{ album.title }}" 
                                                 class="w-full h-full object-cover object-center transition-transform duration-300 ease-in-out group-hover:scale-105" 
                                                 loading="lazy">
                                        {% else %}
                                            <div class="w-full h-full bg-muted flex items-center justify-center">
                                                <i class="fas fa-book text-4xl text-muted-foreground"></i>
                                            </div>
                                        {% endif %}
                                    </a>
                                </div>
                                <!-- Text Content Container -->
                                <div class="p-5 sm:p-6 flex flex-col justify-between flex-grow">
                                    <div>
                                        <!-- Title and Badges -->
                                        <div class="flex justify-between items-start mb-2 gap-x-2">
                                            <h3 class="text-lg font-semibold text-card-foreground leading-snug group-hover:text-primary transition-colors line-clamp-2">
                                                <a href="{{ url_for('main.album_detail', album_id=album.id, album_title='album') }}">{{ album.title }}</a>
                                            </h3>
                                            <div class="flex gap-1 mt-0.5 flex-shrink-0">
                                                <span class="bg-primary text-primary-foreground px-2 py-0.5 rounded text-xs font-semibold">Album</span>
                                                {% if album.is_premium %}
                                                    <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-semibold">Premium</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <!-- Album Description -->
                                        <p class="text-sm text-muted-foreground mb-4 line-clamp-3">{{ album.description[:140] }}...</p>
                                    </div>
                                    <!-- Meta Footer: Date, Views -->
                                    <div class="mt-4 pt-3 border-t border-border text-xs text-muted-foreground flex flex-wrap items-center gap-x-3 gap-y-1">
                                        <span class="flex items-center gap-x-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M4 1.75a.75.75 0 0 1 .75.75V3h6.5V2.5a.75.75 0 0 1 1.5 0V3h.5A1.75 1.75 0 0 1 15 4.75v8.5A1.75 1.75 0 0 1 13.25 15H2.75A1.75 1.75 0 0 1 1 13.25v-8.5A1.75 1.75 0 0 1 2.75 3H3.5V2.5a.75.75 0 0 1 4 1.75ZM2.5 7.75v5.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-5.5H2.5Zm11-3H2.5V4.75c0-.138.112-.25.25-.25h10.5a.25.25 0 0 1 .25.25V5Z" clip-rule="evenodd" /></svg>
                                            {{ album.created_at.strftime('%d %b %Y') }}
                                        </span>
                                        <span class="flex items-center gap-x-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3.5 h-3.5"><path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" /><path fill-rule="evenodd" d="M1.38 8.28a.87.87 0 0 1 0-.56C2.415 6.11 4.96 4 8 4s5.585 2.11 6.62 3.72a.87.87 0 0 1 0 .56C13.585 9.89 11.04 12 8 12s-5.585-2.11-6.62-3.72ZM8 10.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" clip-rule="evenodd" /></svg>
                                            {{ album.total_views }} dilihat
                                        </span>
                                    </div>
                                    
                                    {% if current_user.is_authenticated and current_user.id == user.id %}
                                        <div class="mt-3 flex space-x-2">
                                            <a href="{{ url_for('albums.edit_album', album_id=album.id) }}" 
                                               class="flex-1 bg-secondary text-secondary-foreground text-center py-2 px-3 rounded text-sm hover:bg-secondary/90 transition-colors">
                                                <i class="fas fa-edit mr-1"></i>Edit
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-book text-4xl text-muted-foreground mb-4"></i>
                    <h3 class="text-lg font-medium text-foreground mb-2">Belum ada album</h3>
                    <p class="text-muted-foreground mb-4">Pengguna ini belum membuat album apapun.</p>
                    {% if current_user.is_authenticated and current_user.id == user.id %}
                        <a href="{{ url_for('albums.create_album') }}" 
                           class="bg-primary text-primary-foreground px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Buat Album Pertama Anda
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <!-- Saved List Tab -->
        <div id="saved-list-content" class="space-y-6 {% if active_tab != 'saved-list' %}hidden{% endif %}">
            {% if library_items %}
                <div class="space-y-6">
                    {% for library_item, news, album in library_items %}
                        <article class="bg-card rounded-lg shadow-sm border border-border overflow-hidden transition-all duration-300 hover:border-primary/30 hover:shadow-lg group">
                            <div class="flex flex-col sm:flex-row">
                                <!-- Image Container -->
                                <div class="sm:w-1/4 lg:w-1/3 xl:w-1/4 flex-shrink-0 bg-secondary overflow-hidden aspect-video sm:aspect-auto">
                                    {% if news %}
                                        <a href="{{ url_for('main.news_detail', news_id=news.id, news_title='story') }}" class="block h-full" aria-label="Read story: {{ news.title | e }}">
                                            {% if news.image_id %}
                                                <img src="{{ url_for('static', filename='uploads/' + news.image.filename) }}" 
                                                     alt="{{ news.title }}" 
                                                     class="w-full h-full object-cover object-center transition-transform duration-300 ease-in-out group-hover:scale-105" 
                                                     loading="lazy">
                                            {% else %}
                                                <div class="w-full h-full bg-muted flex items-center justify-center">
                                                    <i class="fas fa-newspaper text-4xl text-muted-foreground"></i>
                                                </div>
                                            {% endif %}
                                        </a>
                                    {% elif album %}
                                        <a href="{{ url_for('main.album_detail', album_id=album.id, album_title='album') }}" class="block h-full" aria-label="View album: {{ album.title | e }}">
                                            {% if album.cover_image_id %}
                                                <img src="{{ url_for('static', filename='uploads/' + album.cover_image.filename) }}" 
                                                     alt="{{ album.title }}" 
                                                     class="w-full h-full object-cover object-center transition-transform duration-300 ease-in-out group-hover:scale-105" 
                                                     loading="lazy">
                                            {% else %}
                                                <div class="w-full h-full bg-muted flex items-center justify-center">
                                                    <i class="fas fa-book text-4xl text-muted-foreground"></i>
                                                </div>
                                            {% endif %}
                                        </a>
                                    {% else %}
                                        <div class="w-full h-full bg-muted flex items-center justify-center">
                                            <i class="fas fa-file text-4xl text-muted-foreground"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <!-- Text Content Container -->
                                <div class="p-5 sm:p-6 flex flex-col justify-between flex-grow">
                                    <div>
                                        <!-- Title and Badges -->
                                        <div class="flex justify-between items-start mb-2 gap-x-2">
                                            <h3 class="text-lg font-semibold text-card-foreground leading-snug group-hover:text-primary transition-colors line-clamp-2">
                                                {% if news %}
                                                    <a href="{{ url_for('main.news_detail', news_id=news.id, news_title='story') }}">{{ news.title }}</a>
                                                {% elif album %}
                                                    <a href="{{ url_for('main.album_detail', album_id=album.id, album_title='album') }}">{{ album.title }}</a>
                                                {% else %}
                                                    <span class="text-muted-foreground">Content #{{ library_item.content_id }}</span>
                                                {% endif %}
                                            </h3>
                                            <div class="flex gap-1 mt-0.5 flex-shrink-0">
                                                {% if news %}
                                                    <span class="bg-primary text-primary-foreground px-2 py-0.5 rounded text-xs font-semibold">Cerita</span>
                                                {% elif album %}
                                                    <span class="bg-secondary text-secondary-foreground px-2 py-0.5 rounded text-xs font-semibold">Album</span>
                                                {% else %}
                                                    <span class="bg-muted text-foreground px-2 py-0.5 rounded text-xs font-semibold">{{ library_item.content_type|title }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <!-- Content Excerpt -->
                                        <p class="text-sm text-muted-foreground mb-4 line-clamp-3">
                                            {% if news %}
                                                {{ news.content[:140] }}...
                                            {% elif album %}
                                                {{ album.description[:140] }}...
                                            {% else %}
                                                Konten tersimpan
                                            {% endif %}
                                        </p>
                                    </div>
                                    <!-- Meta Footer: Date Added and Actions -->
                                    <div class="mt-4 pt-3 border-t border-border">
                                        <div class="flex items-center justify-between">
                                            <div class="text-xs text-muted-foreground flex items-center gap-x-1">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M4 1.75a.75.75 0 0 1 .75.75V3h6.5V2.5a.75.75 0 0 1 1.5 0V3h.5A1.75 1.75 0 0 1 15 4.75v8.5A1.75 1.75 0 0 1 13.25 15H2.75A1.75 1.75 0 0 1 1 13.25v-8.5A1.75 1.75 0 0 1 2.75 3H3.5V2.5a.75.75 0 0 1 4 1.75ZM2.5 7.75v5.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-5.5H2.5Zm11-3H2.5V4.75c0-.138.112-.25.25-.25h10.5a.25.25 0 0 1 .25.25V5Z" clip-rule="evenodd" /></svg>
                                                Ditambahkan {{ library_item.added_at.strftime('%d %b %Y') }}
                                            </div>
                                            <button onclick="removeFromLibrary('{{ library_item.content_type }}', {{ library_item.content_id }})" 
                                                    class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">
                                                <i class="fas fa-trash mr-1.5"></i>
                                                Hapus
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-bookmark text-4xl text-muted-foreground mb-4"></i>
                    <h3 class="text-lg font-medium text-foreground mb-2">Tidak ada konten tersimpan</h3>
                    <p class="text-muted-foreground mb-4">Pengguna ini belum menyimpan konten apapun.</p>
                </div>
            {% endif %}
        </div>

        <!-- Reading History Tab -->
        <div id="reading-history-content" class="space-y-6 {% if active_tab != 'reading-history' %}hidden{% endif %}">
            {% if reading_history %}
                <div class="space-y-6">
                    {% for history_item, news, album in reading_history %}
                        <article class="bg-card rounded-lg shadow-sm border border-border overflow-hidden transition-all duration-300 hover:border-primary/30 hover:shadow-lg group">
                            <div class="flex flex-col sm:flex-row">
                                <!-- Image Container -->
                                <div class="sm:w-1/4 lg:w-1/3 xl:w-1/4 flex-shrink-0 bg-secondary overflow-hidden aspect-video sm:aspect-auto">
                                    {% if news %}
                                        <a href="{{ url_for('main.news_detail', news_id=news.id, news_title='story') }}" class="block h-full" aria-label="Read story: {{ news.title | e }}">
                                            {% if news.image_id %}
                                                <img src="{{ url_for('static', filename='uploads/' + news.image.filename) }}" 
                                                     alt="{{ news.title }}" 
                                                     class="w-full h-full object-cover object-center transition-transform duration-300 ease-in-out group-hover:scale-105" 
                                                     loading="lazy">
                                            {% else %}
                                                <div class="w-full h-full bg-muted flex items-center justify-center">
                                                    <i class="fas fa-newspaper text-4xl text-muted-foreground"></i>
                                                </div>
                                            {% endif %}
                                        </a>
                                    {% elif album %}
                                        <a href="{{ url_for('main.album_detail', album_id=album.id, album_title='album') }}" class="block h-full" aria-label="View album: {{ album.title | e }}">
                                            {% if album.cover_image_id %}
                                                <img src="{{ url_for('static', filename='uploads/' + album.cover_image.filename) }}" 
                                                     alt="{{ album.title }}" 
                                                     class="w-full h-full object-cover object-center transition-transform duration-300 ease-in-out group-hover:scale-105" 
                                                     loading="lazy">
                                            {% else %}
                                                <div class="w-full h-full bg-muted flex items-center justify-center">
                                                    <i class="fas fa-book text-4xl text-muted-foreground"></i>
                                                </div>
                                            {% endif %}
                                        </a>
                                    {% else %}
                                        <div class="w-full h-full bg-muted flex items-center justify-center">
                                            <i class="fas fa-file text-4xl text-muted-foreground"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <!-- Text Content Container -->
                                <div class="p-5 sm:p-6 flex flex-col justify-between flex-grow">
                                    <div>
                                        <!-- Title and Badges -->
                                        <div class="flex justify-between items-start mb-2 gap-x-2">
                                            <h3 class="text-lg font-semibold text-card-foreground leading-snug group-hover:text-primary transition-colors line-clamp-2">
                                                {% if news %}
                                                    <a href="{{ url_for('main.news_detail', news_id=news.id, news_title='story') }}">{{ news.title }}</a>
                                                {% elif album %}
                                                    <a href="{{ url_for('main.album_detail', album_id=album.id, album_title='album') }}">{{ album.title }}</a>
                                                {% else %}
                                                    <span class="text-muted-foreground">Content #{{ history_item.content_id }}</span>
                                                {% endif %}
                                            </h3>
                                            <div class="flex gap-1 mt-0.5 flex-shrink-0">
                                                {% if news %}
                                                    <span class="bg-primary text-primary-foreground px-2 py-0.5 rounded text-xs font-semibold">Cerita</span>
                                                {% elif album %}
                                                    <span class="bg-secondary text-secondary-foreground px-2 py-0.5 rounded text-xs font-semibold">Album</span>
                                                {% else %}
                                                    <span class="bg-muted text-foreground px-2 py-0.5 rounded text-xs font-semibold">{{ history_item.content_type|title }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <!-- Content Excerpt -->
                                        <p class="text-sm text-muted-foreground mb-4 line-clamp-3">
                                            {% if news %}
                                                {{ news.content[:140] }}...
                                            {% elif album %}
                                                {{ album.description[:140] }}...
                                            {% else %}
                                                Konten dari riwayat membaca
                                            {% endif %}
                                        </p>
                                    </div>
                                    <!-- Meta Footer: Read Count, Last Read -->
                                    <div class="mt-4 pt-3 border-t border-border text-xs text-muted-foreground flex flex-wrap items-center gap-x-3 gap-y-1">
                                        <span class="flex items-center gap-x-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3.5 h-3.5"><path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" /><path fill-rule="evenodd" d="M1.38 8.28a.87.87 0 0 1 0-.56C2.415 6.11 4.96 4 8 4s5.585 2.11 6.62 3.72a.87.87 0 0 1 0 .56C13.585 9.89 11.04 12 8 12s-5.585-2.11-6.62-3.72ZM8 10.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" clip-rule="evenodd" /></svg>
                                            Dibaca {{ history_item.read_count }} kali
                                        </span>
                                        <span class="flex items-center gap-x-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3.5 h-3.5"><path fill-rule="evenodd" d="M4 1.75a.75.75 0 0 1 .75.75V3h6.5V2.5a.75.75 0 0 1 1.5 0V3h.5A1.75 1.75 0 0 1 15 4.75v8.5A1.75 1.75 0 0 1 13.25 15H2.75A1.75 1.75 0 0 1 1 13.25v-8.5A1.75 1.75 0 0 1 2.75 3H3.5V2.5a.75.75 0 0 1 4 1.75ZM2.5 7.75v5.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-5.5H2.5Zm11-3H2.5V4.75c0-.138.112-.25.25-.25h10.5a.25.25 0 0 1 .25.25V5Z" clip-rule="evenodd" /></svg>
                                            Terakhir dibaca {{ history_item.last_read_at.strftime('%d %b %Y') }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-history text-4xl text-muted-foreground mb-4"></i>
                    <h3 class="text-lg font-medium text-foreground mb-2">Tidak ada riwayat membaca</h3>
                    <p class="text-muted-foreground mb-4">Pengguna ini belum memiliki riwayat membaca apapun.</p>
                </div>
            {% endif %}
        </div>

        <!-- Response Tab -->
        <div id="response-content" class="space-y-6 {% if active_tab != 'response' %}hidden{% endif %}">
            <div class="text-center py-12">
                <i class="fas fa-comments text-4xl text-muted-foreground mb-4"></i>
                <h3 class="text-lg font-medium text-foreground mb-2">Riwayat Komentar</h3>
                <p class="text-muted-foreground mb-4">Manajemen riwayat komentar akan segera hadir</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = ['your-list', 'saved-list', 'reading-history', 'response'];
    const tabElements = {};
    const contentElements = {};

    // Initialize tab and content elements
    tabs.forEach(tabName => {
        tabElements[tabName] = document.getElementById(tabName + '-tab');
        contentElements[tabName] = document.getElementById(tabName + '-content');
    });

    // Add click event listeners to all tabs
    tabs.forEach(tabName => {
        tabElements[tabName].addEventListener('click', function() {
            // Hide all content
            Object.values(contentElements).forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active state from all tabs
            Object.values(tabElements).forEach(tab => {
                tab.classList.remove('border-primary', 'text-primary');
                tab.classList.add('border-transparent', 'text-muted-foreground');
            });

            // Show selected content
            contentElements[tabName].classList.remove('hidden');

            // Add active state to clicked tab
            tabElements[tabName].classList.add('border-primary', 'text-primary');
            tabElements[tabName].classList.remove('border-transparent', 'text-muted-foreground');
        });
    });
});

// Library management functions
function addToLibrary(contentType, contentId) {
    fetch('/api/library/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content_type: contentType,
            content_id: contentId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Ditambahkan ke perpustakaan');
        } else {
            showToast('error', data.error || 'Gagal menambahkan ke perpustakaan');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Gagal menambahkan ke perpustakaan');
    });
}

function removeFromLibrary(contentType, contentId) {
    fetch('/api/library/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content_type: contentType,
            content_id: contentId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Dihapus dari perpustakaan');
            // Optionally refresh the page or remove the item from DOM
            location.reload();
        } else {
            showToast('error', data.error || 'Gagal menghapus dari perpustakaan');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Gagal menghapus dari perpustakaan');
    });
}

// Simple toast function if not already available
function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = `fixed top-5 right-5 p-4 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}